<?xml version="1.0"?>
<Profiles xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <Lua><![CDATA[
ABILITY_TABLE = { };
EVENT_MODS    = { };
COMBATLOG_MODS= { };
LOSS_TABLE    = { };
NOTIFY_CAST_TABLE = { };
LAST_TARGET   = 0;

-- Константы горячих клавиш
mkLeftShift     = 1;
mkLeftControl   = 2;
mkLeftAlt       = 3;
mkRightShift    = 4;
mkRightControl  = 5;
mkRightAlt      = 6;

-- Ауры, которые позволяют произносить заклинания на ходу
moving_spell_table = {
    97128,  -- Опаляющее перо (Алисразор)
    79206,  -- Благосклонность предков (Шанам)
    108839, -- Плавучая льдина
    165803, -- Награнд (талбук)
    172106,      -- Дух лисы (Охотник)
};

-- Возвращает, есть ли один из перечисленных бафов на персонаже
-- Возвращает:
--  Имя эффекта
--  Количество стаков
--  Оставшееся время действия
--  value1, value2, value3 - Величина эффекта
-- Параметры:
--  unit - Цель ("palyer", "target", "focus", "mouseover")
--  {...} - перечень бафов
--  filter - фильтр
function HasBuff(unit, spellId, filter)
    local spell_table = { };
    if type(spellId) == "table" then
        spell_table = spellId;
    elseif type(spellId) == "number" then
        spell_table = { spellId };
    end

    for _,spell_id in ipairs(spell_table) do
        local spellName, spellRank = GetSpellInfo(spell_id);
        if spellName then
            -- name, rank, icon, count, dispelType, duration, expires, caster, isStealable, shouldConsolidate, spellID, canApplyAura, isBossDebuff, value1, value2, value3
            local name,_,_,count,_,_,expires,_,_,_,_,_,_,value1,value2,value3 = UnitBuff(unit, spellName, spellRank, filter);
            if name then
                local rem = min(max((expires or 0) - (GetTime() - (AddonFrame.ping or 0)), 0), 0xffff);
                return name, count, rem, value1, value2, value3;
            end
        end
    end
    return nil, 0, 0, nil, 0, 0;
end

-- Возвращает, есть ли один из перечисленных дебафов на персонаже
-- Возвращает:
--  Имя эффекта
--  Количество стаков
--  Оставшееся время действия
--  value1, value2, value3 - Величина эффекта
-- Параметры:
--  unit - Цель ("palyer", "target", "focus", "mouseover")
--  {...} - перечень дебафов
--  filter - фильтр
function HasDebuff(unit, spellId, filter)
    local spell_table = { };
    if type(spellId) == "table" then
        spell_table = spellId;
    elseif type(spellId) == "number" then
        spell_table = { spellId };
    end

    for _,spell_id in ipairs(spell_table) do
        local spellName, spellRank = GetSpellInfo(spell_id);
        if spellName then
            -- name, rank, icon, count, dispelType, duration, expires, caster, isStealable, shouldConsolidate, spellID, canApplyAura, isBossDebuff, value1, value2, value3
            local name,_,_,count,_,_,expires,_,_,_,_,_,_,value1,value2,value3 = UnitDebuff(unit, spellName, spellRank, filter);
            if name then
                local rem = min(max((expires or 0) - (GetTime() - (AddonFrame.ping or 0)), 0), 0xffff);
                return name, count, rem, value1, value2, value3;
            end
        end
    end
    return nil, 0, 0, nil, 0, 0;
end

-- Вызвращает время до восстановления заклинания
-- Параметр: ид заклинания
function SpellCD(m_spell)
    local start, duration, enable = GetSpellCooldown(m_spell);
    local cooldown = duration + start - GetTime();
    return (cooldown > 0 and cooldown - (AddonFrame.ping or 0) or 0), enable;
end

-- Проверка, двигается ли игрок, за исключением бафов, которые дают возможность кастровать на ходу
-- на пример: Опаляющее перо (Алисразор), Благосклонность предков (Шанам)
function IsMoving()
    for _, spell in ipairs(moving_spell_table) do
        local name,rank = GetSpellInfo(spell);
        if name and UnitAura("player", name, rank, nil) then
            return;
        end
    end
    return GetUnitSpeed("player") ~= 0 or IsFalling();
end

-- Проверка на нахождение цели в зоне видимости персонажа
function IsNotLineOfSight(unit, sec)
    local rec = LOSS_TABLE[UnitGUID(unit)];
    return rec and (GetTime() - rec.ctime) <= (sec or 1);
end

-- возвращает текущее значение здоровья в процентах
function HealthByPercent(m_target)
    return UnitExists(m_target) and 100 * (UnitHealth(m_target) or 1) / (UnitHealthMax(m_target) or 1) or 0;
end

-- возвращает текущее значение ресурса (мана, энергия, фокус, ярость ...) в процентах
function PowerByPercent(m_target, m_powertype)
    return UnitExists(m_target) and 100 * (UnitPower(m_target, m_powertype) or 1) / (UnitPowerMax(m_target, m_powertype) or 1) or 0;
end

-- Проверка, была ли зажата клавиша модификатор mk*
function IsModKeyDown(m_key)
    if not GetCurrentKeyBoardFocus() then
        return (m_key == mkLeftShift    and IsLeftShiftKeyDown()   ) or
               (m_key == mkLeftControl  and IsLeftControlKeyDown() ) or
               (m_key == mkLeftAlt      and IsLeftAltKeyDown()     ) or
               (m_key == mkRightShift   and IsRightShiftKeyDown()  ) or
               (m_key == mkRightAlt     and IsRightAltKeyDown()    ) or
               (m_key == mkRightControl and IsRightControlKeyDown());
    end
end

-- Возвращает дистанцию между двумя игроками
function GetDistance(unit1, unit2)
    local lvl, a1, b1, a2, b2 = GetCurrentMapDungeonLevel();
    if not (a1 and b1 and a2 and b2) then
        lvl, a1, y1, a2, y2 = GetCurrentMapZone();
    end
    if a1 and b1 and a2 and b2 then
        local x1, y1 = GetPlayerMapPosition(unit1);
        local x2, y2 = GetPlayerMapPosition(unit2);
        local dX = ((x1 - x2) * abs(a2 - a1)) ^ 2;
        local dY = ((y1 - y2) * abs(b2 - b1)) ^ 2;
        return sqrt(dX + dY);
    end
end

-- Проверка, имеется ли у персонажа указанный символ
function HasGlyph(glyphid)
    for slot = 1, 6 do
        if select(4, GetGlyphSocketInfo(slot)) == glyphid then
            return slot;
        end
    end
end

-- Использование предмета в инвентаре
-- Если предмет (перчатка, тринька, пояс и т.п) юзабелен и не имеет КД - имитируем клик правой кн. мыши.
function UseItemBySlot(slotId)
    local start, duration, enable = GetInventoryItemCooldown("player", slotId);
    if duration == 0 and enable == 1 then
        UseInventoryItem(slotId);
    end
end

-- Использование предмета в инвентаре по его ID
function UseItemById(itemId)
    local count = GetItemCount(itemId);
    if (count or 0) > 0 then
        local start,duration,enable = GetItemCooldown(itemId);
        if start == 0 and duration == 0 and enable then
            UseItemByName(itemId);
        end
    end
end

-- Возвращает ID юнита
function UnitId(unit)
    return tonumber((UnitGUID(unit) or ""):sub(6, 10), 16);
end

-- Проверяет, надо ли сбивать заклинание текущему юниту.
function CheckInterrupt(unit, sec)
    -- чтение заклинания прерываем только перед окончанием каста.
    local name,_,_,_,startTime,endTime,isTrade,_,notInterruptible = UnitCastingInfo(unit);
    if name and not (notInterruptible or isTrade) then
        if (((endTime / 1000) - GetTime()) - AddonFrame.ping) <= (sec or 1) then
            return true;
        end
    end
    -- канальное заклинание прерываем сразу.
    local name,_,_,_,_,_,isTrade,notInterruptible = UnitChannelInfo(unit);
    if name and not (notInterruptible or isTrade) then
        return true;
    end
end

-- Проверяет наличие исступления.
function CheckEnrage(unit, ...)
    if UnitCanAttack("player", unit) then
        -- Исступление отображается как пустая строка
        local dispels = { "", ... };
        for i = 1, 40 do
            local name,_,_,_,dispelType = UnitBuff(unit, i);
            if not name then
                return;
            end
            for _, dispell in ipairs(dispels) do
                if dispelType == dispell then
                    return true;
                end
            end
        end
    end
end

function IsMountedEx()
   return IsMounted() and not HasBuff("player", 165803);
end

-----------------------------------------------
--                    HEAL                   --
-----------------------------------------------

MAIN_CLASS_SPELL = 0;

DISPELL_TABLE = { --    Магия         Яд             Болезнь         Проклятие
    PRIEST_HEAL     = { Magic = true, Poison = nil , Disease = true, Curse = nil  },
    PRIEST_NONE     = { Magic = nil , Poison = nil , Disease = true, Curse = nil  },
    DRUID_HEAL      = { Magic = true, Poison = true, Disease = nil , Curse = true },
    DRUID_NONE      = { Magic = nil , Poison = true, Disease = nil , Curse = true },
    PALADIN_HEAL    = { Magic = true, Poison = true, Disease = true, Curse = nil  },
    PALADIN_NONE    = { Magic = nil , Poison = true, Disease = true, Curse = nil  },
    MONK_HEAL       = { Magic = true, Poison = true, Disease = true, Curse = nil  },
    MONK_NONE       = { Magic = nil , Poison = true, Disease = true, Curse = nil  },
    SHAMAN_HEAL     = { Magic = true, Poison = nil , Disease = nil , Curse = true },
    SHAMAN_NONE     = { Magic = nil , Poison = nil , Disease = nil , Curse = nil  },
    MAGE_NONE       = { Magic = nil , Poison = nil , Disease = nil , Curse = true },
};

-- Добавляет в таблицу "members" указанного юнита, при этом делая проверки (возможность лечить)
function InsertNewUnitToHeallersTable(unit)
    if UnitExists(unit)
        and not UnitIsDeadOrGhost(unit)
        and not UnitIsCorpse(unit)
        and UnitHealth(unit) > 100
        and     UnitCanAssist(unit, "player")
        and     IsSpellInRange(GetSpellInfo(MAIN_CLASS_SPELL), unit) == 1
        and not IsNotLineOfSight(unit) then
        for _,member in ipairs(members) do
            if UnitGUID(member.Unit) == UnitGUID(unit) then
                return;
            end
        end
        table.insert(members, { Unit = unit, IsInMyParty = false });
    end
end

-- в эту функцию добавляем логику по особому поведению в рейдах
-- на пример, если есть какой-то дебаф, который надо выхиливать.
function CheckInstanseLogic(member)
    -- Осада Огриммара: Малкорок
    -- Отхил не проходит, надо настакивать щит под дебафом
    -- по этому просто занижаем реальное здоровье.
    if HasDebuff(member.Unit, 142861) then
        if HasDebuff(member.Unit, 142863) then -- красный
            member.HP = 50;
        elseif HasDebuff(member.Unit, 142864) then -- желтый
            member.HP = 80;
        elseif HasDebuff(member.Unit, 142865) then -- зеленый
            member.HP = 100;
        else -- без щита
            member.HP = min(member.HP, 50);
        end
    -- Верховный молот: Кодгар (Дебаф: Исторжение магии: Темная магия)
    -- Дебаф вешает щит поглощающий опреленное количество лечения (надо выхиливать)
    elseif HasDebuff(member.Unit, 162184) then
        member.HP = min(member.HP, 50);
    -- Верховный молот: Кодгар (Дебаф: Жгучая энергия)
    -- Цель получает на 35% меньше отхила - надо сейвить
    elseif HasDebuff(member.Unit, 161242) then
        member.HP = min(40, member.HP);
    -- Верховный молот: Кодгар (Дебаф: Нейтрализующий щит)
    -- На цели есть щит поглощающий урон от магии (это основной урон на боссе)
    elseif HasDebuff(member.Unit, 163134) then
        member.HP = 101;
    -- Престол гроз: Тортос (Кристальная оболочка)
    -- Надо настакивть щит поглощающий урон
    elseif HasDebuff(member.Unit, 137633) then
        -- нужно доработать условие
        if not HasDebuff(member.Unit, 140701) then
            member.HP = min(member.HP, 50);
        end
    -- Престол гроз: Наложницы блезнецы (Дебаф: Чудовище из кошмаров)
    -- Вешается на танка, хилить нельзя
    elseif HasDebuff(member.Unit, 137341) then
        member.DontHeal = true;
    end
end

-- логика развеивания заклинаний, тут добавляем условия, которые запрещают развеивать дебафы
function DontDispell(debuffId, member)
    -- ша гордыни: диспелим "Слово тьмы: Погибель" только с дебафом "Дар титанов"
    -- После "Освобождения" Дар титанов больше не кидается, поэтому диспелим по КД
    if debuffId == 144351 then
        if not HasDebuff("player", 144359) and HealthByPercent("boss1") > 30 then
            -- Если на нас много порчи - не диспелим
            if UnitPower("player", SPELL_POWER_ALTERNATE_POWER) > 50 then
                return true;
            end
        end
    -- Глубиний
    elseif debuffId == 143579 then
        if select(2, HasDebuff(member.Unit, 143579)) < 3 then
            return true;
        end
    -- Осада ограммара: Малкорок
    -- Блуждающая энергия: надо диспелить когда возле цели разсеивания нету других игроков
    elseif debuffId == 142913 then
        for i,member2 in ipairs(members) do
            if not UnitIsUnit("player", member2.Unit) then
                if (GetDistance(member.Unit, member2.Unit) or 0) < 8 then
                    return true;
                end
            end
        end
    -- Верховный молот: Ко'гар
    -- Исторжение магии: огонь - надо диспелить когда рядом (5м) нет играков
    elseif debuffId == 162185 then
        for i,member2 in ipairs(members) do
            if not UnitIsUnit("player", member2.Unit) then
                if (GetDistance(member.Unit, member2.Unit) or 0) < 5 then
                    return true;
                end
            end
        end
    -- Прикосновение скверны (треш перед боссом Ша гордыни)
    -- Диспелятся сразу все дебафы, а при диспеле наносится урон.
    elseif debuffId == 149207 then
        return true;
    -- Дрожащие тени (Железные леди)
    elseif debuffId == 156214 then
        return true;
    -- Лучевой ожог (Огнебаба)
    elseif debuffId == 155049 then
        return true;
    end
end

-- Возвращает юнита, с которого надо диспелить (с наибольшим количеством стаков)
-- Параметр dispeller_type - Указывает тип диспеллера ( "NONE", "HEAL", "SIMBIOS")
-- По умолчанию: "NONE"
-- Возвращает: unit, count или nil - если диспелить нечего.
function GetDispellInfo(dispeller_type)
    local dispeller = dispeller_type or "NONE";
    local d_class   = select(2, UnitClass("player"));
    local c_rec     = DISPELL_TABLE[d_class.."_"..dispeller];

    if not c_rec then return end

    local dispellTable = { };
    for _,member in ipairs(members) do
        for index = 1, 40 do
            local name,_,_,count,dispelType,duration,expires,_,_,_,debuffId = UnitDebuff(member.Unit, index);
            if not name then break end
            if c_rec[dispelType] and not DontDispell(debuffId, member) then
                table.insert(dispellTable, { Unit = member.Unit, Count = count, HP = member.HP });
            end
        end
    end
    if #dispellTable > 0 then
        if #dispellTable > 1 then
            table.sort(dispellTable, function(A, B)
                return A.Count > B.Count;
            end);
        end
        return dispellTable[1].Unit, dispellTable;
    end
end

-- Формирует таблицу "members" которая содержит юнитов нуждающихся в лечении.
-- при формировании происходят проверки: (доступность + рейдовая логика)
-- сформированная таблица будет отсортирована по наименьшему здоровью.
function FillPartyTables(standartSpellId)
    -- Обнуляем все хиловские глобальные переменные.
    MAIN_CLASS_SPELL = standartSpellId;
    LowHP   = { };
    members = { { Unit = "player", IsInMyParty = true } };

    for i = 95, 10, -5 do
        LowHP["H"..i] = 0;
    end

    local prefix = IsInRaid() and "raid" or "party";

    for index = 1, GetNumGroupMembers() do
        local unit = prefix..index;
        if UnitExists(unit)
            and not UnitIsCorpse(unit)
            and not UnitIsUnit("player", unit)
            and     UnitIsConnected(unit)
            and not UnitIsEnemy("player", unit)
            and not UnitIsDeadOrGhost(unit)
            and     UnitInRange(unit)
            and not IsNotLineOfSight(unit) then
            table.insert(members, { Unit = unit, IsInMyParty = true });
        end
    end

    -- отхил дружественной цели по mouseover/target/focus
    InsertNewUnitToHeallersTable("target");
    InsertNewUnitToHeallersTable("focus");
    InsertNewUnitToHeallersTable("mouseover");

    -- Обновляем статы игроков из пати/рейда
    for index = #members, 1, -1 do
        local member = members[index];

        member.IsTank  = UnitGroupRolesAssigned(member.Unit) == "TANK";
        member.Agro    = UnitThreatSituation(member.Unit) or 0;

        local max_hp   = UnitHealthMax(member.Unit) or 0;
        local inc_hp   = UnitGetIncomingHeals(member.Unit) or 0;
        local inc_abs  = UnitGetTotalAbsorbs(member.Unit) or 0;
        local cur_hp   = UnitHealth(member.Unit) or 0;

        member.IncHeal = 100 * inc_hp  / max_hp;
        member.Absorb  = 100 * inc_abs / max_hp;
        member.HP      = 100 * (cur_hp + inc_hp) / max_hp;

        -- логика по особому поведению в рейдах
        CheckInstanseLogic(member);

        if member.IsTank then
            members.HasTank = true;
        end

        -- подсчет количества персонажей с определенным уровнем здоровья (95-10) с шагом в -5
        -- не учитываем цели, которые хилить нельзя
        if not member.DontHeal then
            for i = 95, 10, -5 do
                if member.HP <= i then
                    LowHP["H"..i] = LowHP["H"..i] + 1;
                end
            end
        end

        -- удаляем из талицы юнит, которого нельзя хилить
        if member.DontHeal then
            table.remove(members, index);
        end
    end
    -- сортируем таблицы по наименьшему количеству ХР
    if #members > 1 then
        table.sort(members, function(x, y) return x.HP < y.HP; end);
    elseif #members == 0 then
        -- Это надо для того, чтобы небыло ошибок при обращении к первому элементу
        -- Возможны ситуации что в таблице никого не останется, из-за рейдовой логики.
        members = {{ Unit = "none", Agro = 0, HP = 100, IncHeal = 0 }};
    end
end

---------------------------------------
--              CORE                 --
---------------------------------------
function CheckKnownAbility(ability)
    local spellName = GetSpellInfo(ability.SpellId);
    ability.IsKnown = false;

    if not spellName then
        print("|cff15bd05Invalid spell for id ", ability.SpellId.."|r")
        return;
    end
    --assert(spellName, "Invalid spell for id "..ability.SpellId);

    -- Основная проверка
    if IsPlayerSpell(ability.SpellId)
        or IsSpellKnown(ability.SpellId) or IsSpellKnown(ability.SpellId, true)
        or IsTalentSpell(spellName) then
        ability.IsKnown = true;
        return;
    end

    if GetSpecialization() then
        -- Проверка на доступность заклинания по уровню и специализиции
        local spellList = { GetSpecializationSpells(GetSpecialization()) };
        local lvl = UnitLevel("player");
        for i = 1, #spellList, 2 do
            if spellList[i] == ability.SpellId and lvl > (spellList[i+1] or 0) then
                ability.IsKnown = true;
                return;
            end
        end
    end

    -- Есть заклинания, которые имеют одинаковое название и разные Id
    local spellId = select(2, GetSpellBookItemInfo(spellName));
    if spellId and ability.SpellId ~= spellId then
        if DebugMode then
            print(string.format("|cff15bd05Заклинание: %s Id %d -> %d|r", spellName, ability.SpellId, spellId));
        end
        ability.SpellId = spellId;
        ability.IsKnown = true;
    end
end

-- Проверяем доступность заклинаний
function CheckAllSpells()
    if type(ABILITY_TABLE) == "table" then
        for _,ability in ipairs(ABILITY_TABLE) do
            if ability.SpellId > 0 then
                CheckKnownAbility(ability);
            end
        end
    end
end

function CheckAndCastAbility(ability, targetInfo)
    if ability.IsCheckInCombat and not UnitAffectingCombat("player") then
        return;
    end

    if ability.SetRecastDelay
        and targetInfo.Guid == UnitGUID(targetInfo.Target)
        and targetInfo.LastCastingTime >= GetTime() then
        return;
    end

    local spellName = GetSpellInfo(ability.SpellId);
    if not spellName and ability.SpellId > 0 then
        return;
    end

    if ability.SpellId < 1 then
        return ability.Func(ability, targetInfo, targetInfo.Target);
    elseif not (ability.IsKnown and IsUsableSpell(spellName)) then
        return;
    end

    local start, duration = GetSpellCooldown(ability.SpellId);
    if (duration + start - GetTime()) > AddonFrame.ping then
        return;
    end

    local castPing = AddonFrame.ping * 1000;
    if not ability.CancelCasting then
        local endTime = select(6, UnitCastingInfo("player")) or 0;
        if (endTime - (GetTime() * 1000)) >= castPing then
            return;
        end
    end

    if not ability.DropChanel then
        local endTime = select(6, UnitChannelInfo("player")) or 0;
        if (endTime - (GetTime() * 1000)) >= castPing then
            return;
        end
    end

    if (ability.IsMovingCheck == "notmoving"  and IS_MOVING)
    or (ability.IsMovingCheck == "moving" and not IS_MOVING) then
        return;
    end

    local result = ability.Func(ability, targetInfo, targetInfo.Target);
    if not result then
        return;
    elseif type(result) == "string" then
        targetInfo.Target = result;
    end

    if targetInfo.Target ~= "none" and targetInfo.Target ~= "player" and targetInfo.Target ~= "mouselocation" then
        if not UnitExists(targetInfo.Target) then
            return;
        elseif SpellHasRange(spellName) and IsSpellInRange(spellName, targetInfo.Target) == 0 then
            return;
        elseif IsHelpfulSpell(spellName) and not UnitIsFriend("player", targetInfo.Target) then
            return;
        elseif IsHarmfulSpell(spellName) and UnitIsFriend("player", targetInfo.Target) then
            return;
        elseif not UnitIsFriend("player", targetInfo.Target) then
            if UnitIsDeadOrGhost(targetInfo.Target) or not UnitCanAttack("player", targetInfo.Target) then
                return;
            end
        end
    end

    if ability.CancelCasting or ability.DropChanel then
        SpellStopCasting();
    end

    targetInfo.Guid = UnitGUID(targetInfo.Target);
    targetInfo.LastCastingTime = GetTime() + 1 + (select(7, GetSpellInfo(ability.SpellId)) or 0) / 1000;

    if targetInfo.Target == "mouselocation" then
        CastSpellByName(spellName, nil);
        CameraOrSelectOrMoveStart();
        CameraOrSelectOrMoveStop();
        CastSpellByName(spellName, nil);
    elseif targetInfo.Target == "none" then
        LAST_TARGET = UnitGUID("player");
        CastSpellByName(spellName, nil);
    else
        LAST_TARGET = UnitGUID(targetInfo.Target);
        CastSpellByName(spellName, targetInfo.Target);
    end
    return true;
end

function AddonFrame_OnEvent(self, event, ...)
    if event == "PLAYER_ENTERING_WORLD" then
        self:Show();
        CheckAllSpells();
    elseif event == "PLAYER_LOGOUT" then
        ChangeRotation();
    elseif event == "WORLD_MAP_UPDATE" then
        LOSS_TABLE = { };
    elseif event == "SPELLS_CHANGED" then
        CheckAllSpells();
    elseif event == "COMBAT_LOG_EVENT_UNFILTERED" then
        local timestamp, subEvent, hideCaster,
              sourceGUID,srcName,  sourceFlags,sourceFlags2,
              destGUID,  destName, destFlags,  destFlags2,
              spellId,   spellName,spellSchool, param15 = ...;
        if subEvent == "SPELL_CAST_SUCCESS" and sourceGUID == UnitGUID("player") then
            if DebugMode and NOTIFY_CAST_TABLE[spellId] then
                print(tostring(NOTIFY_CAST_TABLE[spellId]).." на "..(destName or ""));
            end
            for _,ability in ipairs(ABILITY_TABLE) do
                for _,targetInfo in ipairs(ability.TargetList) do
                    if spellId == ability.SpellId and UnitGUID(targetInfo.Target) == destGUID then
                        targetInfo.Guid = destGUID;
                        targetInfo.LastCastingTime = GetTime() + 1;
                        --print(string.format("%s %d (%s) guid: (%s) %s time: %s", subEvent,spellId, spellName, targetInfo.Target, destGUID, targetInfo.LastCastingTime));
                    end
                end
            end
        elseif subEvent == "SPELL_CAST_FAILED" and sourceGUID == UnitGUID("player") then
            if DebugMode then
                print(format("%s - |cfff5360c%s|r", GetSpellLink(spellId), param15));
            end
            if param15 == SPELL_FAILED_LINE_OF_SIGHT then
                LOSS_TABLE[destGUID] = { ctime  = GetTime(), cspell = spellId };
            end
            for _,ability in ipairs(ABILITY_TABLE) do
                for _,targetInfo in ipairs(ability.TargetList) do
                    if spellId == ability.SpellId and UnitGUID(targetInfo.Target) == LAST_TARGET then
                        targetInfo.Guid = nil;
                        targetInfo.LastCastingTime = 0;
                        --print(string.format("%s %d (%s) guid: (%s) %s time: %s", subEvent,spellId, spellName, targetInfo.Target, destGUID, targetInfo.LastCastingTime));
                        if param15 == SPELL_FAILED_NOT_BEHIND or       -- Вы должны находиться позади цели.
                           --param15 == SPELL_FAILED_BAD_TARGETS or      -- Нельзя применить к этой цели.
                           param15 == SPELL_FAILED_UNIT_NOT_INFRONT or -- Цель должна быть перед вами.
                           param15 == SPELL_FAILED_VISION_OBSCURED or  -- Вы с трудом видите цель
                           param15 == SPELL_FAILED_LINE_OF_SIGHT then  -- Цель вне поля зрения.
                            targetInfo[param15] = GetTime();
                        end
                    end
                end
            end
        end
        if type(COMBATLOG_MODS[subEvent]) == "function" then
            COMBATLOG_MODS[subEvent](...);
        end
    end

    if type(EVENT_MODS[event]) == "function" then
        EVENT_MODS[event](...);
    end
end

function IsKeyDown(key)
    assert(key, 'Не указана клавиша');
    if AddonFrame.Buttons[key] then
        return AddonFrame.Buttons[key].IsDown and not GetCurrentKeyBoardFocus();
    end
end

function RegisterKeyHandler(key, handler)
    assert(key, "Невозможно зарегистрировать пустую клавишу");
    local bname = "__button_"..key.."__";

    handler = type(handler) == "function" and handler or function(self, button, down)
        if AddonFrame.Buttons[self.Key] then
            AddonFrame.Buttons[self.Key].IsDown = down;
        end
    end

    -- Сначала почистим старую кнопку
    if type(AddonFrame.Buttons[key]) == "table" and type(AddonFrame.Buttons[key].UnregisterAllEvents) == "function" then
        AddonFrame.Buttons[key]:SetScript("OnClick", nil);
        AddonFrame.Buttons[key]:UnregisterAllEvents();
        AddonFrame.Buttons[key] = nil;
    end

    AddonFrame.Buttons[key] = CreateFrame("BUTTON", bname, AddonFrame)
    AddonFrame.Buttons[key].Key = key;
    AddonFrame.Buttons[key].IsDown = nil;
    AddonFrame.Buttons[key]:RegisterForClicks("AnyUp","AnyDown");
    AddonFrame.Buttons[key]:SetScript("OnClick", handler);

    local isBind = nil;
    local bind = GetBindingByKey(key);
    if bind and ActionBarButtonEventsFrame.frames then
        -- Далее, надо сделать проверку по всех фреймах.
        -- Но возможно обойдемся и панелями команд.
        for _, frame in ipairs(ActionBarButtonEventsFrame.frames) do
            if strupper(frame:GetName()) == bind then
                SetOverrideBindingClick(frame, false, key, bname);
                --print('Зарегистрирована клавиша', key);
                isBind = 1;
            end
        end
    else
        AddonFrame.print("|cfff5360cНе удалось найти привязку для клавиши "..tostring(key).."|r", 1);
    end

    if not isBind then
        AddonFrame.print("|cfff5360cНе удалось зарегистрировать обработку для клавиши \'"..tostring(key).."\'|r", 1);
    end
end

function AddonFrame_AbilityLoop()
   for _,ability in ipairs(ABILITY_TABLE) do
        for _,targetInfo in ipairs(ability.TargetList or { "none" }) do
            if CheckAndCastAbility(ability, targetInfo) then
                return;
            end
        end
    end
end

function AddonFrame_OnUpdate(self, elapsed)
    if type(ABILITY_TABLE) == "table" and GetTime() >= (AddonFrame.LastTime or 0) then
        if AddonFrame.CurentRotation and not UnitIsDeadOrGhost("player") and not UnitIsAFK("player") then
            IS_MOVING = IsMoving();
            AddonFrame.ping = select(4, GetNetStats()) / 1000;
            AddonFrame_AbilityLoop();
        end
        AddonFrame.LastTime = GetTime() + math.random(150, 250) / 1000;
    end
    if (AddonFrame.Duration or 0) < GetTime() then
        AddonFrame.Msg:SetText("");
    end
end

if type(AddonFrame) == "table" then
    AddonFrame:UnregisterAllEvents();
    -- Очистим предыдущие биндинги
    for _, frame in ipairs(ActionBarButtonEventsFrame.frames) do
        ClearOverrideBindings(frame)
    end

    -- Снимем обработчики с уже существующих кнопок
    if type(AddonFrame.Buttons) == "table" then
        for _, button in ipairs(AddonFrame.Buttons) do
            if type(button.UnregisterAllEvents) == "function" then
                button:SetScript("OnClick", nil);
                button:UnregisterAllEvents();
                button = nil;
            end
        end
    end

    -- Пересоздадим таблицу кнопок
    AddonFrame.Buttons = {};
end

if type(AddonFrame) ~= "table" then
    AddonFrame = CreateFrame("Frame");
    AddonFrame:SetScript("OnUpdate", AddonFrame_OnUpdate);
    AddonFrame:SetScript("OnEvent",  AddonFrame_OnEvent);
    AddonFrame:SetHeight(300);
    AddonFrame:SetWidth(600);
    AddonFrame.Buttons = {};
    AddonFrame.Msg = AddonFrame:CreateFontString(nil, "BACKGROUND", "PVPInfoTextFont");
    AddonFrame.Msg:SetAllPoints();
    AddonFrame.print = function(msg, con)
        AddonFrame.Msg:SetText(msg);
        if con then print(msg) end
        AddonFrame.Duration = GetTime() + 5;
    end
    AddonFrame:SetPoint("CENTER", 0, 200);
    AddonFrame:Show();
end

function ChangeRotation(rotation)
    --assert(type(AddonFrame) ~= "table",
    --    '\"AddonFrame\" не существует в текущем контексте');
    if not AddonFrame then return end;
    if AddonFrame.CurentRotation and (not rotation or rotation == AddonFrame.CurentRotation) then
        AddonFrame.CurentRotation = nil;
        AddonFrame:UnregisterAllEvents();
        AddonFrame.print("|cfff5360cРотация отключена.|r", true);
        PlaySound("PAPERDOLLCLOSE", "Master");
    elseif rotation then
        AddonFrame:RegisterEvent("COMBAT_LOG_EVENT_UNFILTERED");
        AddonFrame:RegisterEvent("PLAYER_ENTERING_WORLD");
        AddonFrame:RegisterEvent("PLAYER_LOGOUT");
        AddonFrame:RegisterEvent("WORLD_MAP_UPDATE");
        AddonFrame:RegisterEvent("MODIFIER_STATE_CHANGED");
        AddonFrame:RegisterEvent("SPELLS_CHANGED");
        AddonFrame.CurentRotation = rotation;
        AddonFrame.print("|cff15bd05Ротация: |r|cff6f0a9a"..rotation.."|r|cff15bd05 - Включена.|r", true);
        PlaySound("PAPERDOLLOPEN", "Master");
        CheckAllSpells();
    end
end
]]></Lua>
  <Profile Class="Warrior">
    <Lua><![CDATA[
useCooldown = true;
setAoE      = nil;
isAltMod    = nil;

reflect_table = {
    PVP = {
        33786,  -- DRUID   (Смерч)
        28272,  -- MAGE    (Превращение - Свинья)
        118,    -- MAGE    (Превращение - Овца)
        61305,  -- MAGE    (Превращение - Кошка)
        61721,  -- MAGE    (Превращение - Кролик)
        61780,  -- MAGE    (Превращение - Индейка)
        28271,  -- MAGE    (Превращение - Черепаха)
        113092, -- MAGE    (Ледяная бомба)
        30451,  -- MAGE    (Чародейская вспышка)
        20066,  -- PALADIN (Покаяние)
        605,    -- PRIEST  (Господство над разумом)
        51514,  -- SHAMAN  (Сглаз)
        51505,  -- SHAMAN  (Выброс лавы)
        5782,   -- WARLOCK (Страх)
        118699, -- WARLOCK (Страх)
        116858  -- WARLOCK (Стрела Хаоса)
    },
    RAIDS = {
        144214, -- Стрела ледяной бури (Кор'кронские Тёмные Шаманы)
    }
};

function NeedReflect(unitEnemy, unitFreind)
    local spell_ids = UnitIsPVP("player") and reflect_table.PVP or reflect_table.RAIDS;

    if UnitIsEnemy("player", unitEnemy) and UnitIsUnit(unitFreind, unitEnemy.."target") then
        local name,_,_,_,_,endTime = UnitCastingInfo(unitEnemy);
        if name and (((endTime / 1000) - GetTime()) - AddonFrame.ping) < 2 then
            for _,spell_id in ipairs(spell_ids) do
                if name == GetSpellInfo(spell_id) then
                    return true;
                end
            end
        end
    end
end

function NeedMassReflect()
    local reflect_buff = { 23920, 114028 };
    if not HasBuff("player", reflect_buff) or SpellCD(23920) > 0 then
        if IsInArenaTeam() then
            for i = 1, 5 do
                for j = 1, 5 do
                    if UnitExists("party"..i) and UnitExists("arena"..j) then
                        return NeedReflect("party"..i, "arena"..j);
                    end
                end
            end
        else
            return NeedReflect("target", "player");
        end
    end
end
]]></Lua>
    <Rotation Name="Защита">
      <HotKey Key="X" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = false;
isAltMod = true;
useInterrupt = true;
useCooldown = true;

RegisterKeyHandler('F');

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        end
    elseif modifier == "RALT" then
        if isAltMod then
            isAltMod = false;
            AddonFrame.print("|cffff0000Используется блок щитом", true);
        else
            isAltMod = true;
            AddonFrame.print("|cff00ff00Используется непроницаемый щит", true);
        end
    elseif modifier == "RCTRL" then
        if useInterrupt then
            useInterrupt = false;
            AddonFrame.print("|cff00ff00Автопрерывания выключены", true);
        else
            useInterrupt = true;
            AddonFrame.print("|cffff0000Автопрерывания включены", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
      <Ability Name="Героический прыжок">
        <SpellID>6544</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Пауза в ротации
if IsModKeyDown(mkLeftAlt) or IsMountedEx() or IsStealthed() then
    return true;
end

-- Перейти в стойку защиты
if GetSpecialization() == 3 and GetShapeshiftForm() ~= 2 then
    CastShapeshiftForm(2);
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

agroStatus = UnitThreatSituation("player") or 0;
isInMeele  = IsSpellInRange(GetSpellInfo(78), "target") == 1;
hasAPbuff  = HasBuff("player", { 57330, 19506});
playerHP   = HealthByPercent("player");
rage       = UnitPower("player");
]]></Lua>
      </Ability>
      <Ability Name="Ударная волна">
        <SpellID>46968</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsKeyDown("F") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Зуботычина">
        <SpellID>6552</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useInterrupt and CheckInterrupt("target");
]]></Lua>
      </Ability>
      <Ability Name="Разрушительный крик">
        <SpellID>102060</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and SpellCD(6552) > 0 and CheckInterrupt("target") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Победный раж">
        <SpellID>34428</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if playerHP <= 80 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Ярость берсерка">
        <SpellID>18499</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
--[[
STUN_MECHANIC
SCHOOL_INTERRUPT
DISARM
PACIFYSILENCE
SILENCE
ROOT
PACIFY
STUN
FEAR
CHARM
CONFUSE
POSSESS
]]

local t = C_LossOfControl.GetEventInfo(1);
if t == 'FEAR' or r == 'PACIFY' or r == 'CHARM' or t == 'CONFUSE' or t == 'POSSESS' then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Непроницаемый щит">
        <SpellID>112048</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isAltMod and not HasBuff("player", 112048) then
    -- Величина решимости в %, максимум 350%
    -- Необходимо вычислить, надо ли делать проверку на наличие решимости
    -- чтобы накладывать щит.

    -- Провести расчеты по определению эфективности использования "Блок щитом" / "Непроницаемый щит"
    local value = select(5, HasBuff("player", 158300));
    local def_val = IsInRaid() and 150 or 100;
    
    -- Если есть здоровье - набираем ярость для большей эфективности щита
    -- Надо еще добавить проверку на наличе бафа "Решимости"
    if rage > 55 and playerHP > 20 then
        return value > def_val;
        --return true;
    -- Если здоровья мало - используем щит когда это возможно
    -- Надо подкорректировать количество минимального здоровья
    elseif rage > 30 and playerHP <= 20 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Блок щитом">
        <SpellID>2565</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- 132404 Блок щитом
if rage >= 60 and agroStatus > 2 and not HasBuff("player", 132404) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Глухая оборона">
        <SpellID>871</SpellID>
        <Target>None</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if playerHP < 30 and agroStatus > 2 and useCooldown then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Одобряющий клич">
        <SpellID>97462</SpellID>
        <Target>None</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInCombat and playerHP < 25 and useCooldown then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Ни шагу назад">
        <SpellID>12975</SpellID>
        <Target>None</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if playerHP < 20 and agroStatus > 2 and useCooldown then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Деморализующий крик">
        <SpellID>1160</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if playerHP <= 50 and isInMeele and useCooldown then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Сокрушительный Бросок">
        <SpellID>64382</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- 5 - RightControl
if IsModKeyDown(5) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Кровавая баня">
        <SpellID>12292</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and isInMeele then
    if UnitHealth(target) > (UnitHealthMax("player") * 3) then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Удар грома (AOE)">
        <SpellID>6343</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and setAoE then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Мощный удар щитом">
        <SpellID>23922</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Казнь">
        <SpellID>5308</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
--if UnitIsPlayer(target) then
--    return true;
--elseif rage > 60 and (playerHP > 70 or agroStatus < 3) then
--    return true;
--end
]]></Lua>
      </Ability>
      <Ability Name="Отражение заклинания">
        <SpellID>23920</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Код профиля
return NeedReflect(target, "player");
]]></Lua>
      </Ability>
      <Ability Name="Массовое отражение заклинаний">
        <SpellID>114028</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return NeedMassReflect();
]]></Lua>
      </Ability>
      <Ability Name="Подрезать сухожилья">
        <SpellID>1715</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if UnitIsPlayer(target) and not HasDebuff(target, 1715) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Реванш">
        <SpellID>6572</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- дает 20 ярости
return true;
]]></Lua>
      </Ability>
      <Ability Name="Удар героя">
        <SpellID>78</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Это заклинание не затрагивает ГКД
-- Неприклонные удары (169685)
local count = select(2, HasBuff("player", 169685));
if count == 6 then
    return true;
elseif count == 5 and (rage > 70 or playerHP > 70) then
    return true;
elseif rage > 70 and playerHP > 70 then
    return true;
elseif agroStatus < 3 and playerHP > 70 then
    return true;
-- (Ультиматум - 122510)
elseif HasBuff("player", 122510) or rage > 70 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Сокрушение">
        <SpellID>20243</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return isInMeele;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Неистовство">
      <HotKey Key="Z" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = 0;
useCooldown = true;
useInterrupt = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        setAoE = setAoE or 0;
        if setAoE == 0 then
            setAoE = 1;
            AddonFrame.print("|cff6f0a9aКливы", true);
        elseif setAoE == 1 then
            setAoE = 2;
            AddonFrame.print("|cffff0000AOE", true);
        else
            setAoE = 0;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        end
    elseif modifier == "RCTRL" then
        if useInterrupt then
            useInterrupt = false;
            AddonFrame.print("|cff00ff00Автопрерывания выключены", true);
        else
            useInterrupt = true;
            AddonFrame.print("|cffff0000Автопрерывания включены", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
      <Ability Name="Героический прыжок">
        <SpellID>6544</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- модификатор
if type(setAoE) ~= "number" then
    setAoE = 0;
end

if IsMouseButtonDown(4) then
    for index = 1, NUM_WORLD_RAID_MARKERS do
        if not IsRaidMarkerActive(index) then
            PlaceRaidMarker(index);
            break;
        end
    end
    return true;
end

-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMountedEx() or IsStealthed() then
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

isInMeele = IsSpellInRange(GetSpellInfo(5308), "target") == 1;
]]></Lua>
      </Ability>
      <Ability Name="Победный раж">
        <SpellID>34428</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return HealthByPercent("player") < 90;
]]></Lua>
      </Ability>
      <Ability Name="Зуботычина">
        <SpellID>6552</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useInterrupt and CheckInterrupt("target");
]]></Lua>
      </Ability>
      <Ability Name="Разрушительный крик">
        <SpellID>102060</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return isInMeele and CheckInterrupt("target");
]]></Lua>
      </Ability>
      <Ability Name="Ярость берсерка">
        <SpellID>18499</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
--[[
STUN_MECHANIC
SCHOOL_INTERRUPT
DISARM
PACIFYSILENCE
SILENCE
ROOT
PACIFY
STUN
FEAR
CHARM
CONFUSE
POSSESS
]]

-- надо правильно определить типы снимаемого контроля
local t = C_LossOfControl.GetEventInfo(1);
if t == 'FEAR' or r == 'PACIFY' or r == 'CHARM' or t == 'CONFUSE' or t == 'POSSESS' then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Безразсудство">
        <SpellID>1719</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and isInMeele then
    UseItemBySlot(INVSLOT_TRINKET1);
    UseItemBySlot(INVSLOT_TRINKET2);
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Кровавая баня">
        <SpellID>12292</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and isInMeele then
    UseItemBySlot(INVSLOT_TRINKET1);
    UseItemBySlot(INVSLOT_TRINKET2);
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Вихрь">
        <SpellID>1680</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local setAoE = setAoE or 0;
if isInMeele then
    if setAoE == 2 then
        return true;
    elseif setAoE == 1 then
        return select(2, HasBuff("player", 12950)) < 2;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Казнь">
        <SpellID>5308</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Яростный выпад">
        <SpellID>85288</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Удар громовержца">
        <SpellID>107570</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return setAoE < 2;
]]></Lua>
      </Ability>
      <Ability Name="Рев дракона">
        <SpellID>118000</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return isInMeele;
]]></Lua>
      </Ability>
      <Ability Name="Зверский удар">
        <SpellID>100130</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return setAoE < 2;
]]></Lua>
      </Ability>
      <Ability Name="Кровожадность">
        <SpellID>23881</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Героический бросок">
        <SpellID>57755</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Оружие">
      <HotKey Key="C" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = 0;
useCooldown = true;
useInterrupt = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        setAoE = setAoE or 0;
        if setAoE == 0 then
            setAoE = 1;
            AddonFrame.print("|cff6f0a9aКливы", true);
        elseif setAoE == 1 then
            setAoE = 2;
            AddonFrame.print("|cffff0000AOE", true);
        else
            setAoE = 0;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        end
    elseif modifier == "RCTRL" then
        if useInterrupt then
            useInterrupt = false;
            AddonFrame.print("|cff00ff00Автопрерывания выключены", true);
        else
            useInterrupt = true;
            AddonFrame.print("|cffff0000Автопрерывания включены", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
      <Ability Name="Героический прыжок">
        <SpellID>6544</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- модификатор
if type(setAoE) ~= "number" then
    setAoE = 0;
end

-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() then
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

rage       = UnitPower("player");
playerHP   = HealthByPercent("player");
targetHP   = HealthByPercent("target");
isInMeele  = IsSpellInRange(GetSpellInfo(78), "target") == 1;
koloss,_,kolossRem = HasDebuff("target", 86346, "PLAYER");
koloss_cd  = SpellCD(86346);
]]></Lua>
      </Ability>
      <Ability Name="Победный раж">
        <SpellID>34428</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return playerHP <= 80;
]]></Lua>
      </Ability>
      <Ability Name="Зуботычина">
        <SpellID>6552</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useInterrupt and CheckInterrupt("target");
]]></Lua>
      </Ability>
      <Ability Name="Отражение заклинания">
        <SpellID>23920</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Код профиля
return NeedReflect(target, "player");
]]></Lua>
      </Ability>
      <Ability Name="Массовое отражение заклинаний">
        <SpellID>114028</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Код профиля
return NeedMassReflect();
]]></Lua>
      </Ability>
      <Ability Name="Подрезать сухожилья">
        <SpellID>1715</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if UnitIsPlayer(target) and not HasDebuff(target, 1715) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Разрушительный крик">
        <SpellID>102060</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and SpellCD(6552) > 0 and CheckInterrupt("target") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Кровавая Баня">
        <SpellID>12292</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and useCooldown and (koloss_cd < 2 or kolossRem > 4) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Ярость Берсерка">
        <SpellID>18499</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if UnitIsPVP("player") then
    if not HasFullControl() then
        return true;
    end
elseif isInMeele and rage < 20 and not HasBuff("player", 12880) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Размашистые удары">
        <SpellID>12328</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return isInMeele and setAoE > 0;
]]></Lua>
      </Ability>
      <Ability Name="Удар грома">
        <SpellID>6343</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and setAoE > 0
    -- Глубокие раны
    and not HasDebuff("target", 115767, "PLAYER") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Вихрь">
        <SpellID>1680</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return isInMeele and setAoE > 1;
]]></Lua>
      </Ability>
      <Ability Name="Рев дракона">
        <SpellID>118000</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and not koloss then
    --if HasBuff("player", 12292) then
        return true;
    --end
end
]]></Lua>
      </Ability>
      <Ability Name="Смертельный удар">
        <SpellID>12294</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Удар колосса">
        <SpellID>86346</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return kolossRem < 2;
]]></Lua>
      </Ability>
      <Ability Name="Удар громовержца">
        <SpellID>107570</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if UnitIsPVP("player") then
    if UnitHasControl("mouseover") then
        return "mouseover";
    end
elseif koloss then
    return "target";
end
]]></Lua>
      </Ability>
      <Ability Name="Удар героя">
        <SpellID>78</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return setAoE == 0 and rage > 80;
]]></Lua>
      </Ability>
      <Ability Name="Казнь">
        <SpellID>5308</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Мощный удар">
        <SpellID>1464</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return (rage > 40 or HasBuff("player", 1719))
    and HealthByPercent(target) > 20;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Гладиатор">
      <HotKey Key="V" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = false;
useInterrupt = true;
useCooldown = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        end
    elseif modifier == "RCTRL" then
        if useInterrupt then
            useInterrupt = false;
            AddonFrame.print("|cff00ff00Автопрерывания выключены", true);
        else
            useInterrupt = true;
            AddonFrame.print("|cffff0000Автопрерывания включены", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
      <Ability Name="Героический прыжок">
        <SpellID>6544</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Пауза в ротации
if IsModKeyDown(mkLeftAlt) or IsMountedEx() or IsStealthed() then
    return true;
end

-- Перейти в стойку защиты
if GetSpecialization() == 3 and GetShapeshiftForm() ~= 1 then
    CastShapeshiftForm(1);
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

agroStatus = UnitThreatSituation("player") or 0;
isInMeele  = IsSpellInRange(GetSpellInfo(78), "target") == 1;
hasAPbuff  = HasBuff("player", { 57330, 19506});
playerHP   = HealthByPercent("player");
rage       = UnitPower("player");
]]></Lua>
      </Ability>
      <Ability Name="Зуботычина">
        <SpellID>6552</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useInterrupt and CheckInterrupt("target");
]]></Lua>
      </Ability>
      <Ability Name="Победный раж">
        <SpellID>34428</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if playerHP <= 80 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Ярость берсерка">
        <SpellID>18499</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
--[[
STUN_MECHANIC
SCHOOL_INTERRUPT
DISARM
PACIFYSILENCE
SILENCE
ROOT
PACIFY
STUN
FEAR
CHARM
CONFUSE
POSSESS
]]

local t = C_LossOfControl.GetEventInfo(1);
if t == 'FEAR' or r == 'PACIFY' or r == 'CHARM' or t == 'CONFUSE' or t == 'POSSESS' then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Кровавая баня">
        <SpellID>12292</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and isInMeele then
    if UnitHealth(target) > (UnitHealthMax("player") * 3) then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Атака щитом">
        <SpellID>156321</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- 
if isInMeele and not HasBuff("player", 169667) then
    if rage > 25 and SpellCD(23922) <= 1.5 then
        -- 169686 Неприклонные удары
        --if select(2, HasBuff("", 169686)) > 1 then
            return true;
        --end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Удар грома (AOE)">
        <SpellID>6343</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and setAoE then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Мощный удар щитом">
        <SpellID>23922</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Реванш">
        <SpellID>6572</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- дает 20 ярости
return true;
]]></Lua>
      </Ability>
      <Ability Name="Удар героя">
        <SpellID>78</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Это заклинание не затрагивает ГКД
-- (Ультиматум - 122510)
if HasBuff("player", 122510) or rage > 70 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Сокрушение">
        <SpellID>20243</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return isInMeele;
]]></Lua>
      </Ability>
      <Ability Name="Героический бросок">
        <SpellID>57755</SpellID>
        <Target>Target</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
    </Rotation>
  </Profile>
  <Profile Class="Paladin">
    <Lua><![CDATA[
agroStatus  = 0;
useCooldown = true;
setAoE      = nil;
]]></Lua>
    <Rotation Name="Защита">
      <HotKey Key="X" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = false;
useCooldown = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() then
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

agroStatus = UnitThreatSituation("player");
isInMeele  = IsSpellInRange(GetSpellInfo(35395), "target") == 1;
playerHP   = HealthByPercent("player");
hollyPower = UnitPower("player", SPELL_POWER_HOLY_POWER);

divine_purpose = HasBuff("player", 90174);  -- Божественный замысел
holy_avenger   = HasBuff("player", 105809); -- Святая клятва
inquisition,_,inquisition_rem = HasBuff("player", 84963); -- дознание
]]></Lua>
      </Ability>
      <Ability Name="Щит небес">
        <SpellID>20925</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not HasBuff("player", 20925, "PLAYER") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Вечное пламя">
        <SpellID>114163</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if hollyPower > 2 and select(3, HasBuff("player", 114163, "PLAYER")) < 2 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Торжество">
        <SpellID>130551</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if playerHP < 70 then
    if divine_purpose or hollyPower > 2 then
        -- Бастион славы (114637)
        if (select(2, HasBuff("player", 114637)) or 0) > 4 then
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Щит праведника">
        <SpellID>53600</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if divine_purpose or hollyPower > 2 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Ревностный защитник">
        <SpellID>31850</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if playerHP < 15 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Защитник древних королей">
        <SpellID>86659</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if playerHP < 40 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Божественная защита">
        <SpellID>498</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if playerHP < 60 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Молот праведника">
        <SpellID>53595</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Должен быть дебаф на Слабые Удары (115798)
return setAoE;
]]></Lua>
      </Ability>
      <Ability Name="Удар воина света">
        <SpellID>35395</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not setAoE;
]]></Lua>
      </Ability>
      <Ability Name="Молот гнева">
        <SpellID>24275</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Божественная призма">
        <SpellID>114165</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Щит мстителя">
        <SpellID>31935</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Правосудие">
        <SpellID>20271</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Освящение">
        <SpellID>26573</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and not HasDebuff("target", 26573, "PLAYER") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Гнев небес">
        <SpellID>119072</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return isInMeele;
]]></Lua>
      </Ability>
      <Ability Name="Праведное неистовство">
        <SpellID>25780</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not HasBuff("player", 25780) then
    return true;
end
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Лекарь">
      <HotKey Key="Z" Modifier="Alt" />
    </Rotation>
    <Rotation Name="Воздаяние">
      <HotKey Key="C" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = false;
useCooldown = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Пауза в ротации
if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() then
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

isInMeele  = IsSpellInRange(GetSpellInfo(35395), "target") == 1;
playerHP   = HealthByPercent("player");
hollyPower = UnitPower("player", SPELL_POWER_HOLY_POWER);
]]></Lua>
      </Ability>
      <Ability Name="Укор">
        <SpellID>96231</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckInterrupt("target");
]]></Lua>
      </Ability>
      <Ability Name="Очищение">
        <SpellID>4987</SpellID>
        <Target>Focus</Target>
        <Target>Player</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local dispells = DISPELL_TABLE["PALADIN_NONE"];
if dispells then
    for index = 1, 40 do
        local name, _,_,_, dispelType = UnitDebuff(target, index);
        if not name then break end
        if dispells[dispelType] then
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Вспышка света">
        <SpellID>19750</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Самоотверженный целитель (3 стака)
if playerHP < 80 and select(2, HasBuff("player", 114250)) > 2 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Гнев карателя">
        <SpellID>31884</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and isInMeele then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Святой каратель">
        <SpellID>105809</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and hollyPower <= 2 and isInMeele then
    -- Защитник древних королей
    if SpellCD(86698) < 289 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Смертный приговор">
        <SpellID>114157</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useCooldown;
]]></Lua>
      </Ability>
      <Ability Name="Вердикт храмовника">
        <SpellID>85256</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not setAoE and hollyPower > 4;
]]></Lua>
      </Ability>
      <Ability Name="Божественная буря">
        <SpellID>53385</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return setAoE and hollyPower > 2;
]]></Lua>
      </Ability>
      <Ability Name="Молот гнева">
        <SpellID>24275</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Экзорцизм">
        <SpellID>879</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Удар воина Света">
        <SpellID>35395</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not setAoE;
]]></Lua>
      </Ability>
      <Ability Name="Молот праведника">
        <SpellID>53595</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return setAoE;
]]></Lua>
      </Ability>
      <Ability Name="Правосудие">
        <SpellID>20271</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Вердикт храмовника">
        <SpellID>85256</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not setAoE and hollyPower > 2;
]]></Lua>
      </Ability>
    </Rotation>
  </Profile>
  <Profile Class="Hunter">
    <Lua><![CDATA[
useCooldown = true;
setAoE      = nil;
isAltMod    = nil;

setAoE = false;
useCooldown = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
    <Rotation Name="Выживание">
      <HotKey Key="X" Modifier="Alt" />
      <Lua><![CDATA[
NOTIFY_CAST_TABLE[19801] = "|cff15bd05>> Снимаю исступление!";
]]></Lua>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- модификатор
if IsModKeyDown(mkLeftAlt) or IsStealthed() then
    StopAttack();
    PetStopAttack();
    -- перейдем в аспект ястребя
    if GetShapeshiftForm() ~= 1 then
        CastShapeshiftForm(1);
    end
    return true;
end

-- если притворились мертвыми
if HasBuff("player", 5384) then
    return true;
end

isInRange = IsSpellInRange(GetSpellInfo(3044), "target") == 1;

---- При проке "На изготовку" прерываем чтение "Выстрел кобры"
--if not setAoE and UnitCastingInfo("player") == GetSpellInfo(77767) then
--    if HasBuff("player", 56453) then
--        SpellStopCasting();
--    end
--end

-- Установка пета в указанную позицию
if IsMouseButtonDown(4) then
    PetMoveTo();
    CameraOrSelectOrMoveStart();
    CameraOrSelectOrMoveStop();
    PetMoveTo();
end
]]></Lua>
      </Ability>
      <Ability Name="Метание ловушки">
        <SpellID>77769</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not HasBuff("player", 77769);
]]></Lua>
      </Ability>
      <Ability Name="Взрывная ловушка">
        <SpellID>13813</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Ледяная ловушка">
        <SpellID>13809</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkRightAlt);
]]></Lua>
      </Ability>
      <Ability Name="Замораживающая ловушка">
        <SpellID>1499</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkRightControl);
]]></Lua>
      </Ability>
      <Ability Name="Триньки/перчатки">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsMounted() or IsStealthed() then
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

if useCooldown then
    UseItemBySlot(INVSLOT_HAND);
    UseItemBySlot(INVSLOT_TRINKET1);
    UseItemBySlot(INVSLOT_TRINKET2);
end
]]></Lua>
      </Ability>
      <Ability Name="Рык">
        <SpellID>0</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
--if not GetSpellAutocast(ability.SpellId, "pet") then
--    if not (UnitInRaid("player") or UnitInParty("player")) then
--        if UnitThreatSituation("pet", "target") < 2 then
--            return true;
--        end
--    end
--end
]]></Lua>
      </Ability>
      <Ability Name="Перенаправление">
        <SpellID>34477</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsMouseButtonDown(5) then
    if UnitExists("focus") and UnitIsFriend("player", "focus") and not UnitIsDeadOrGhost("focus") then
        return "fucus";
    elseif UnitExists("mouseover") and UnitIsFriend("player", "mouseover") and not UnitIsDeadOrGhost("mouseover") then
        return "mouseover";
    elseif UnitExists("pet") and not UnitIsDeadOrGhost("pet") then
        return "pet";
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Встречный выстрел">
        <SpellID>147362</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Усмиряющий выстрел">
        <SpellID>19801</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if CheckEnrage(target) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Лечение питомца">
        <SpellID>136</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local pethp = HealthByPercent("pet");
if pethp ~= 0 and pethp < 75 then
    if not HasBuff("pet", 136) then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Шквал">
        <SpellID>120360</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if setAoE then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Выстрел кобры">
        <SpellID>77767</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
--if SpellCD(120360) < 1 and setAoE and IsTalentSpell(GetSpellInfo(120360)) then
--    return isInRange;
--end
]]></Lua>
      </Ability>
      <Ability Name="Залп">
        <SpellID>2643</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return setAoE;
]]></Lua>
      </Ability>
      <Ability Name="Разрывной выстрел">
        <SpellID>53301</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Черная стрела">
        <SpellID>3674</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not setAoE;
]]></Lua>
      </Ability>
      <Ability Name="Бросок глеф">
        <SpellID>117050</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Ужасный зверь">
        <SpellID>120679</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useCooldown and isInRange;
]]></Lua>
      </Ability>
      <Ability Name="Стая воронов">
        <SpellID>131894</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useCooldown and isInRange;
]]></Lua>
      </Ability>
      <Ability Name="Чародейский выстрел">
        <SpellID>3044</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Выстрел кобры">
        <SpellID>77767</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return isInRange;
]]></Lua>
      </Ability>
      <Ability Name="Верный выстрел">
        <SpellID>56641</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Стрельба">
      <HotKey Key="C" Modifier="Alt" />
      <Lua><![CDATA[
NOTIFY_CAST_TABLE[19801] = "|cff15bd05>> Снимаю исступление!";

SteadyShot = 0;

-- function EVENT_MODS.COMBAT_LOG_EVENT_UNFILTERED(...)
--     local spellId = select(12, ...);
--     if subEvent == "SPELL_CAST_SUCCESS" and sourceGUID == UnitGUID("player") then
--         if SteadyShot == 2 then
--             SteadyShot = 0;
--         end
--     elseif subEvent == "SPELL_CAST_START" and sourceGUID == UnitGUID("player") then
--         if spellId == 56641 then
--             SteadyShot = SteadyShot + 1;
--         end
--     elseif subEvent == "SPELL_CAST_FAILED" and sourceGUID == UnitGUID("player") then
--         if spellId == 56641 then
--             SteadyShot = SteadyShot - 1;
--         end
--     end
-- end
]]></Lua>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- модификатор
if IsModKeyDown(mkLeftAlt) or IsStealthed() then
    StopAttack();
    PetStopAttack();
    return true;
end

-- если притворились мертвыми
if HasBuff("player", 5384) then
    return true;
end

isInRange = IsSpellInRange(GetSpellInfo(3044), "target") == 1;

-- Установка пета в указанную позицию
if IsMouseButtonDown(4) then
    PetMoveTo();
    CameraOrSelectOrMoveStart();
    CameraOrSelectOrMoveStop();
    PetMoveTo();
end
]]></Lua>
      </Ability>
      <Ability Name="Метание ловушки">
        <SpellID>77769</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not HasBuff("player", 77769);
]]></Lua>
      </Ability>
      <Ability Name="Взрывная ловушка">
        <SpellID>13813</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Ледяная ловушка">
        <SpellID>13809</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkRightAlt);
]]></Lua>
      </Ability>
      <Ability Name="Замораживающая ловушка">
        <SpellID>1499</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkRightControl);
]]></Lua>
      </Ability>
      <Ability Name="Триньки/перчатки">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsMounted() or IsStealthed() then
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

if useCooldown then
    UseItemBySlot(INVSLOT_HAND);
    UseItemBySlot(INVSLOT_TRINKET1);
    UseItemBySlot(INVSLOT_TRINKET2);
end
]]></Lua>
      </Ability>
      <Ability Name="Рык">
        <SpellID>2649</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not select(2, GetSpellAutocast(GetSpellInfo(ability.SpellId), "pet")) then
    if not (UnitInRaid("player") or UnitInParty("player")) then
        if (UnitThreatSituation("pet", "target") or 0) < 2 then
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Перенаправление">
        <SpellID>34477</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsMouseButtonDown(5) then
    if UnitExists("focus") and UnitIsFriend("player", "focus") and not UnitIsDeadOrGhost("focus") then
        return "fucus";
    elseif UnitExists("mouseover") and UnitIsFriend("player", "mouseover") and not UnitIsDeadOrGhost("mouseover") then
        return "mouseover";
    elseif UnitExists("pet") and not UnitIsDeadOrGhost("pet") then
        return "pet";
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Встречный выстрел">
        <SpellID>147362</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Усмиряющий выстрел">
        <SpellID>19801</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if CheckEnrage(target, "Magic") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Лечение питомца">
        <SpellID>136</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if UnitExists("pet") then
    local pethp = HealthByPercent("pet");
    if pethp ~= 0 and pethp < 75 then
        if not HasBuff("pet", 136) then
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Верный выстрел">
        <SpellID>56641</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Накапливаем концентрацию перед использованием быстрой стрельбы
if useCooldown and UnitPower("player") < 80 then
    if HealthByPercent("target") < 80 and SpellCD(3045) < 4 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Быстрая стрельба">
        <SpellID>3045</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and isInRange and UnitPower("player") > 50 then
    UseItemBySlot(INVSLOT_HAND);
    UseItemBySlot(INVSLOT_TRINKET1);
    UseItemBySlot(INVSLOT_TRINKET2);
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Залп">
        <SpellID>2643</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return setAoE;
]]></Lua>
      </Ability>
      <Ability Name="Выстрел химеры">
        <SpellID>53209</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not setAoE;
]]></Lua>
      </Ability>
      <Ability Name="Убийственный выстрел">
        <SpellID>53351</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Если перк Усиленного убийственного выстрела доступен, то проверяем КД по другому ИД
if not IsSpellOverlayed(157708) or GetSpellCooldown(157708) == 0 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Стая воронов">
        <SpellID>131894</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useCooldown and isInRange;
]]></Lua>
      </Ability>
      <Ability Name="Прицельный выстрел">
        <SpellID>19434</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- (34483) Верная цель
if HasBuff("player", 34483) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Бросок глеф">
        <SpellID>117050</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- (34483) Верная цель
if not HasBuff("player", 34483) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Прицельный выстрел">
        <SpellID>19434</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Верный выстрел">
        <SpellID>56641</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Повелитель зверей">
      <HotKey Key="Z" Modifier="Alt" />
      <Lua><![CDATA[
NOTIFY_CAST_TABLE[19801] = "|cff15bd05>> Снимаю исступление!";
]]></Lua>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- модификатор
if IsModKeyDown(mkLeftAlt) or IsStealthed() then
    StopAttack();
    PetStopAttack();
    return true;
end

-- если притворились мертвыми
if HasBuff("player", 5384) then
    return true;
end

isInRange = IsSpellInRange(GetSpellInfo(3044), "target") == 1;

-- Установка пета в указанную позицию
if IsMouseButtonDown(4) then
    PetMoveTo();
    CameraOrSelectOrMoveStart();
    CameraOrSelectOrMoveStop();
    PetMoveTo();
end
]]></Lua>
      </Ability>
      <Ability Name="Метание ловушки">
        <SpellID>77769</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not HasBuff("player", 77769);
]]></Lua>
      </Ability>
      <Ability Name="Взрывная ловушка">
        <SpellID>82939</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Ледяная ловушка">
        <SpellID>13809</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkRightAlt);
]]></Lua>
      </Ability>
      <Ability Name="Замораживающая ловушка">
        <SpellID>1499</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkRightControl);
]]></Lua>
      </Ability>
      <Ability Name="Триньки/перчатки">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsMounted() or IsStealthed() then
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

if useCooldown then
    UseItemBySlot(INVSLOT_HAND);
    UseItemBySlot(INVSLOT_TRINKET1);
    UseItemBySlot(INVSLOT_TRINKET2);
end
]]></Lua>
      </Ability>
      <Ability Name="Рык">
        <SpellID>0</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
--if not GetSpellAutocast(ability.SpellId, "pet") then
--    if not (UnitInRaid("player") or UnitInParty("player")) then
--        if UnitThreatSituation("pet", "target") < 2 then
--            return true;
--        end
--    end
--end
]]></Lua>
      </Ability>
      <Ability Name="Перенаправление">
        <SpellID>34477</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsMouseButtonDown(5) then
    if UnitExists("focus") and UnitIsFriend("player", "focus") and not UnitIsDeadOrGhost("focus") then
        return "fucus";
    elseif UnitExists("mouseover") and UnitIsFriend("player", "mouseover") and not UnitIsDeadOrGhost("mouseover") then
        return "mouseover";
    elseif UnitExists("pet") and not UnitIsDeadOrGhost("pet") then
        return "pet";
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Встречный выстрел">
        <SpellID>147362</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Усмиряющий выстрел">
        <SpellID>19801</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if CheckEnrage(target) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Лечение питомца">
        <SpellID>136</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local pethp = HealthByPercent("pet");
if pethp ~= 0 and pethp < 75 then
    if not HasBuff("pet", 136) then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Звериный натиск">
        <SpellID>121818</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useCooldown and isInRange;
]]></Lua>
      </Ability>
      <Ability Name="Быстрая стрельба">
        <SpellID>3045</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useCooldown and isInRange;
]]></Lua>
      </Ability>
      <Ability Name="Стая воронов">
        <SpellID>131894</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useCooldown and isInRange;
]]></Lua>
      </Ability>
      <Ability Name="Звериный гнев">
        <SpellID>19574</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInRange and useCooldown then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Залп">
        <SpellID>2643</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return setAoE;
]]></Lua>
      </Ability>
      <Ability Name="Команда Взять!">
        <SpellID>34026</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Убийственный выстрел">
        <SpellID>53351</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Укус змеи">
        <SpellID>1978</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not setAoE and not HasDebuff(target, 118253, "PLAYER") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Бросок глеф">
        <SpellID>117050</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Ужасный зверь">
        <SpellID>120679</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useCooldown and isInRange;
]]></Lua>
      </Ability>
      <Ability Name="Сконцентрированный огонь">
        <SpellID>82692</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInRange and select(2, HasBuff("player", 19615)) > 4 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Чародейский выстрел">
        <SpellID>3044</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local focus = UnitPower("player");
if not setAoE and focus > 40 then
    -- Если Стая воронов скоро откатится, копим для нее концентрацию
    if useCooldown and IsPlayerSpell(131894) and SpellCD(131894) < 2 and focus < 80 then
        return;
    end
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Выстрел кобры">
        <SpellID>77767</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return isInRange;
]]></Lua>
      </Ability>
      <Ability Name="Верный выстрел">
        <SpellID>56641</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Farm">
      <HotKey Key="B" Modifier="Alt" />
      <Ability Name="Укус змеи">
        <SpellID>1978</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- 64399 Боевой штандарт координации
UseItemById(64399);
TargetNearestEnemy();
if UnitExists("target") and not UnitIsDeadOrGhost("target") then
    if IsSpellInRange(GetSpellInfo(3044), "target") == 1 then
        StartAttack("target");
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Выстрел кобры">
        <SpellID>77767</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
TargetNearestEnemy();
if UnitExists("target") and not UnitIsDeadOrGhost("target") then
    if IsSpellInRange(GetSpellInfo(3044), "target") == 1 then
        StartAttack("target");
        return true;
    end
end
]]></Lua>
      </Ability>
    </Rotation>
  </Profile>
  <Profile Class="Rogue">
    <Lua><![CDATA[
setAoE = false;
invisible = false;
useCooldown = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        end
    elseif modifier == "RCTRL" then
        if invisible then
            invisible = false;
            AddonFrame.print("|cffff0000Незаметность выключена", true);
        else
            invisible = true;
            AddonFrame.print("|cff00ff00Незаметность включена", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end

mTempTable = { };
AddonFrame:RegisterEvent("UI_ERROR_MESSAGE");
AddonFrame:RegisterEvent("LOOT_OPENED");

function EVENT_MODS.UI_ERROR_MESSAGE(msg)
    -- Если моба невозможно обократсть.
    -- Или его уже обокрали или у него нет карманов.
    -- Заносим его в таблицу для дальнейшей проверки.
    if UnitExists("target")
        and (msg == SPELL_FAILED_TARGET_NO_POCKETS
          or msg == ERR_ALREADY_PICKPOCKETED) then
        mTempTable[LAST_TARGET] = GetTime();
    end
end

function EVENT_MODS.WORLD_MAP_UPDATE()
    -- очистка таблицы мобов с обшареными карманами
    mTempTable = { };
end

-- Функция проверки на возможность обокрасть цель.
-- Проверяется таблица на присутствие "неправильного моба"
function IsPickPocketed(unit)
    if type(mTempTable) == "table" then
        local lastTime = mTempTable[UnitGUID(unit)] or 0;
        if (lastTime + 300) > GetTime() then
            return true;
        end
    end
end

function EVENT_MODS.LOOT_OPENED()
    for i = 1, GetNumLootItems() do
        local texture, item, quantity = GetLootSlotInfo(i);
        --print(item, quantity);
        if quantity == 0 or item == GetItemInfo(16885) then
            LootSlot(i);
            --print("Looting: ", item);
        end
    end
end
]]></Lua>
    <Rotation Name="Бой">
      <HotKey Key="Z" Modifier="Alt" />
      <Ability Name="Инициализаця">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMounted() then
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

isInRange = IsSpellInRange(GetSpellInfo(1752), "target") == 1;

if invisible and not UnitAffectingCombat("player") and GetShapeshiftForm(1) ~= 1 then
    if GetShapeshiftFormCooldown(1) == 0 then
        CastShapeshiftForm(1);
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Ошеломление">
        <SpellID>6770</SpellID>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not HasDebuff(target, 6770) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Обшаривание карманов">
        <SpellID>921</SpellID>
        <Target>Target</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsMounted() or IsModKeyDown(mkLeftAlt) then
    return true;
end

if GetShapeshiftForm() ~= 1 and GetShapeshiftFormCooldown(1) == 0 then
    CastShapeshiftForm(1);
end

if target == "mouseover" and UnitExists(target) then
    if not IsPickPocketed(target) and not UnitIsDeadOrGhost(target) and UnitCreatureType(target) == "Гуманоид" then
        return true;
    end
end

if target == "target" and UnitExists(target) then
    --TargetNearestEnemy();
    if not IsPickPocketed(target) and not UnitIsDeadOrGhost(target) and UnitCreatureType(target) == "Гуманоид" then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Пинок">
        <SpellID>1766</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Веер клинков">
        <SpellID>51723</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsModKeyDown(mkLeftShift) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Внезапный удар">
        <SpellID>8676</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsStealthed() and IsModKeyDown(mkLeftShift) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Заживление ран">
        <SpellID>73651</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetComboPoints("player") > 4 and HealthByPercent("player") < 80 then
    if not HasBuff("target", 73651, "PLAYER") then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Нахождение в скрытности">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetShapeshiftForm() == 1 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Мясорубка ">
        <SpellID>5171</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local name, count, rem = HasBuff("player", 5171);

if rem == 0 then
    return true;
end

if UnitExists("target") and GetComboPoints("player", "target") > 4 then
    if rem < 4 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Выброс адреналина">
        <SpellID>13750</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInRange and useCooldown then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Череда убийств">
        <SpellID>51690</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInRange and useCooldown and PowerByPercent("player") < 25 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Пробивающий удар">
        <SpellID>84617</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not HasDebuff("target", 84617, "PLAYER") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Рваная рана">
        <SpellID>1943</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetComboPoints("player", "target") > 4 then
    if not HasDebuff("target", 1943, "PLAYER") then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Потрошение">
        <SpellID>2098</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetComboPoints("player", "target") > 4 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Коварный удар">
        <SpellID>1752</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Незаметность">
        <SpellID>1784</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if invisible and not UnitAffectingCombat("player") and GetShapeshiftForm() ~= 1 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Смертоносный яд">
        <SpellID>2823</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>true</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
local buffs = {
    2823,
    8679,
    108211
};

if not HasBuff("player", buffs) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Похищающий  жизнь яд">
        <SpellID>108211</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>true</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
local buffs = {
    108211,
    3408
};

if not HasBuff("player", buffs) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Бросок сюрикена">
        <SpellID>114014</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not isInRange;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Ликвидация">
      <HotKey Key="X" Modifier="Alt" />
      <Ability Name="Инициализаця">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMounted() then
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

-- Если мы в скрытности, то всегда, если возможно прыгаем в форму незаметности
if GetSpecialization() == 3 then
    if GetShapeshiftForm() ~= 1 then
        local start, duration, enable = GetShapeshiftFormCooldown(1);
        if enable == 1 and start == 0 then
            CastShapeshiftForm(1);
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Смертоносный яд">
        <SpellID>2823</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>true</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if not (UnitAffectingCombat("player") or HasBuff("player", 2823)) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Веер клинков">
        <SpellID>51723</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsModKeyDown(mkLeftShift) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Заживление ран">
        <SpellID>73651</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetComboPoints("player") > 4 and HealthByPercent("player") < 80 then
    if not HasBuff("target", 73651, "PLAYER") then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Внезапный удар">
        <SpellID>8676</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetShapeshiftForm() == 1 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Мясорубка ">
        <SpellID>5171</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local name, count, rem = HasBuff("player", 5171);

if rem == 0 then
    return true;
end

if UnitExists("target") and GetComboPoints("player", "target") > 4 then
    if rem < 4 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Вендетта">
        <SpellID>79140</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and IsSpellInRange(GetSpellInfo(1329), "target") == 1 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Рваная рана">
        <SpellID>1943</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetComboPoints("player", "target") > 4 then
    if select(3, HasDebuff(target, 1943, "PLAYER")) < 2 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Отравнеие">
        <SpellID>32645</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetComboPoints("player", "target") > 4 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Устранение">
        <SpellID>111240</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Расправа">
        <SpellID>1329</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Скрытность">
      <HotKey Key="C" Modifier="Alt" />
    </Rotation>
    <Rotation Name="Фарм ларей">
      <HotKey Key="V" Modifier="Alt" />
      <Lua><![CDATA[
mTempTable = { };
AddonFrame:RegisterEvent("UI_ERROR_MESSAGE");
AddonFrame:RegisterEvent("LOOT_OPENED");

function EVENT_MODS.UI_ERROR_MESSAGE(msg)
    -- Если моба невозможно обократсть.
    -- Или его уже обокрали или у него нет карманов.
    -- Заносим его в таблицу для дальнейшей проверки.
    if UnitExists("target")
        and (msg == SPELL_FAILED_TARGET_NO_POCKETS
          or msg == ERR_ALREADY_PICKPOCKETED) then
        mTempTable[LAST_TARGET] = GetTime();
    end
end

function EVENT_MODS.WORLD_MAP_UPDATE()
    -- очистка таблицы мобов с обшареными карманами
    mTempTable = { };
end

-- Функция проверки на возможность обокрасть цель.
-- Проверяется таблица на присутствие "неправильного моба"
function IsPickPocketed(unit)
    if type(mTempTable) == "table" then
        local lastTime = mTempTable[UnitGUID(unit)] or 0;
        if (lastTime + 300) > GetTime() then
            return true;
        end
    end
end

function EVENT_MODS.LOOT_OPENED()
    for i = 1, GetNumLootItems() do
        local texture, item, quantity = GetLootSlotInfo(i);
        --print(item, quantity);
        if quantity == 0 or item == GetItemInfo(16885) then
            LootSlot(i);
            --print("Looting: ", item);
        end
    end
end
]]></Lua>
      <Ability Name="Ошеломление">
        <SpellID>6770</SpellID>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not HasDebuff(target, 6770) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Обшаривание карманов">
        <SpellID>921</SpellID>
        <Target>Mouseover</Target>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsMounted() or IsModKeyDown(mkLeftAlt) then
    return true;
end

if GetShapeshiftForm() ~= 1 and GetShapeshiftFormCooldown(1) == 0 then
    CastShapeshiftForm(1);
end

if target == "mouseover" and UnitExists(target) then
    if not IsPickPocketed(target) and not UnitIsDeadOrGhost(target) and UnitCreatureType(target) == "Гуманоид" then
        return true;
    end
end

if target == "target" and UnitExists(target) then
    --TargetNearestEnemy();
    if not IsPickPocketed(target) and not UnitIsDeadOrGhost(target) and UnitCreatureType(target) == "Гуманоид" then
        return true;
    end
end
]]></Lua>
      </Ability>
    </Rotation>
  </Profile>
  <Profile Class="Priest">
    <Lua><![CDATA[
useCooldown = true;
setAoE      = nil;
useAutoDispell = true;
]]></Lua>
    <Rotation Name="Послушание">
      <HotKey Key="C" Modifier="Alt" />
      <Lua><![CDATA[
useAutoDispell = true;
useCooldown = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "RALT" then
        if useAutoDispell then
            useAutoDispell = false;
            AddonFrame.print("|cffff0000Диспел по mouseover: Выключен", true);
        else
            useAutoDispell = true;
            AddonFrame.print("|cff00ff00Диспел по mouseover: Включен", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
      <Ability Name="Божественное перышко">
        <SpellID>121536</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() then
    return true;
end

FillPartyTables(2061);

myMana = PowerByPercent("player", SPELL_POWER_MANA);

if myMana < 75 then
    --UseItemBySlot(INVSLOT_TRINKET1);
    UseItemBySlot(INVSLOT_TRINKET2);
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end
]]></Lua>
      </Ability>
      <Ability Name="Массовое разсеивание">
        <SpellID>32375</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
return IsMouseButtonDown(4);-- IsModKeyDown(mkLeftAlt);
]]></Lua>
      </Ability>
      <Ability Name="Слово силы: Барьер">
        <SpellID>62618</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsMouseButtonDown(3);-- IsModKeyDown(mkLeftControl);
]]></Lua>
      </Ability>
      <Ability Name="Левитация">
        <SpellID>1706</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- надо тестировать
if not IsFalling() then
    falingStartTime = 0;
elseif IsFalling() and (falingStartTime or 0) == 0 then
    falingStartTime = GetTime();
elseif GetTime() - (falingStartTime or 0) > 1 and not HasBuff("player", 111759) then
    falingStartTime = 0;
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Разсеивание заклинаний (Авто)">
        <SpellID>527</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useAutoDispell then
    return GetDispellInfo("HEAL");
end
]]></Lua>
      </Ability>
      <Ability Name="Подавление боли">
        <SpellID>33206</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and members[1].HP < 30 then
    return members[1].Unit;
end
]]></Lua>
      </Ability>
      <Ability Name="Подчиняющий разум">
        <SpellID>123040</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsSpellInRange(GetSpellInfo(585), "target") == 1 then
    return myMana < 80;
end
]]></Lua>
      </Ability>
      <Ability Name="Придание сил">
        <SpellID>10060</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return LowHP.H50 > 3;
]]></Lua>
      </Ability>
      <Ability Name="Архангел">
        <SpellID>81700</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return LowHP.H70 > 3;
]]></Lua>
      </Ability>
      <Ability Name="Слово силы: Щит">
        <SpellID>17</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Ослабленная душа (6788)
if IsModKeyDown(mkLeftControl)
and UnitExists("mouseover")
and UnitHealth("mouseover") > 100
and UnitIsFriend("player", "mouseover")
and not HasDebuff("mouseover", 6788) then
    return "mouseover";
end

for _, member in ipairs(members) do
    if (not HasDebuff(member.Unit, 6788) and not HasBuff(member.Unit, 17))
        or HasBuff("player", 123266) then
        if (member.IsTank and member.Agro > 2) or IsModKeyDown(mkLeftControl) then
            return member.Unit;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Быстрое исцеление">
        <SpellID>2061</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if members[1].HP < 40 then
    return members[1].Unit;
end
]]></Lua>
      </Ability>
      <Ability Name="Молитва восстановления">
        <SpellID>33076</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if LowHP.H90 > 2 and members[1].HP < 85 then
   return members[1].Unit;
end
]]></Lua>
      </Ability>
      <Ability Name="Молитва Исцеления">
        <SpellID>596</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
-- Если активен щит души, тогда настакиваем щит
if LowHP.H70 > 3 or HasBuff("player", 114908, "PLAYER") then
    return members[1].Unit;
end
]]></Lua>
      </Ability>
      <Ability Name="Великое исцеление">
        <SpellID>2060</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if members[1].HP < 60 then
    return members[1].Unit;
end
]]></Lua>
      </Ability>
      <Ability Name="Обновление">
        <SpellID>139</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
for _,member in ipairs(members) do
   if member.IsTank and member.HP < 70 then
       if not HasBuff(member.Unit, 139, "PLAYER") then
           return member.Unit;
       end
   end
end
]]></Lua>
      </Ability>
      <Ability Name="Исповедь">
        <SpellID>47540</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not UnitIsFriend("target", "player") then
    return "target";
elseif members[1].HP < 60 then
    return members[1].Unit;
end
]]></Lua>
      </Ability>
      <Ability Name="Слово тьмы: Утешение">
        <SpellID>129250</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Слово Тьмы: Смерть">
        <SpellID>32379</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return HealthByPercent("target") < 20;
]]></Lua>
      </Ability>
      <Ability Name="Слово тьмы: Боль">
        <SpellID>589</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if select(3, HasDebuff("target", 589, "PLAYER")) < 2 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Кара">
        <SpellID>585</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Свет">
      <HotKey Key="Z" Modifier="Alt" />
    </Rotation>
    <Rotation Name="Тьма">
      <HotKey Key="X" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = false;
useCooldown = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
      <Ability Name="Божественное перышко">
        <SpellID>121536</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() then
    return true;
end

-- Перейти в форму тьмы
if GetSpecialization() == 3 and GetShapeshiftForm() ~= 1 then
    CastShapeshiftForm(1);
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

isInRange = IsSpellInRange(GetSpellInfo(8092), "target") == 1;

isBurst = IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Левитация">
        <SpellID>1706</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- надо тестировать
if not IsFalling() then
    falingStartTime = 0;
elseif IsFalling() and (falingStartTime or 0) == 0 then
    falingStartTime = GetTime();
elseif GetTime() - (falingStartTime or 0) > 1 and not HasBuff("player", 111759) then
    falingStartTime = 0;
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Массовое разсеивание">
        <SpellID>32375</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftAlt);
]]></Lua>
      </Ability>
      <Ability Name="Искушение разума">
        <SpellID>48045</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return setAoE;
]]></Lua>
      </Ability>
      <Ability Name="Всепожирающая чума">
        <SpellID>2944</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if UnitPower("player", SPELL_POWER_SHADOW_ORBS) > 2 then
    UseItemBySlot(INVSLOT_HAND);
    UseItemBySlot(INVSLOT_TRINKET1);
    UseItemBySlot(INVSLOT_TRINKET2);
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Пытка разума (Безумие)">
        <SpellID>15407</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if HasDebuff("target", 2944, "PLAYER") then
    return isInRange;
end
]]></Lua>
      </Ability>
      <Ability Name="Взрыв разума">
        <SpellID>8092</SpellID>
        <Target>Target</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if not HasDebuff("target", 2944, "PLAYER") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Слово Тьмы: Смерть">
        <SpellID>32379</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not HasDebuff("target", 2944, "PLAYER") then
    return HealthByPercent(target) < 20;
end
]]></Lua>
      </Ability>
      <Ability Name="Сияние">
        <SpellID>120517</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Исчадие тьмы">
        <SpellID>34433</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useCooldown;
]]></Lua>
      </Ability>
      <Ability Name="Пронзание разума">
        <SpellID>73510</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if HasBuff("player", 87160) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Слово тьмы: Боль">
        <SpellID>589</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- 18 sec
local remains = select(3, HasDebuff(target, ability.SpellId, "PLAYER"));
local orbs = UnitPower("player", SPELL_POWER_SHADOW_ORBS);

if not HasDebuff("target", 2944, "PLAYER") then
    if SpellCD(8092) < 4 and remains < 8 and orbs > 1 then
        return true;
    end

    if IS_MOVING or remains < 2 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Прикосновение вампира">
        <SpellID>34914</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>true</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
-- 15 sec
local remains = select(3, HasDebuff(target, ability.SpellId, "PLAYER"));
local orbs = UnitPower("player", SPELL_POWER_SHADOW_ORBS);

if not HasDebuff("target", 2944, "PLAYER") then
    if SpellCD(8092) < 3 and remains < 8 and orbs > 1 then
        return true;
    end

    if remains < 3.5 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Пытка разума">
        <SpellID>15407</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return isInRange;
]]></Lua>
      </Ability>
    </Rotation>
  </Profile>
  <Profile Class="DeathKnight">
    <Lua><![CDATA[
setAoE = false;
useCooldown = true;
isAltMod = nil;
useInterrupt = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    elseif modifier == "RCTRL" then
        if useInterrupt then
            useInterrupt = false;
            AddonFrame.print("|cff00ff00Автопрерывания выключены", true);
        else
            useInterrupt = true;
            AddonFrame.print("|cffff0000Автопрерывания включены", true);
        end
    end
end

local RUNETYPE_BLOOD  = 1;
local RUNETYPE_UNHOLY = 2;
local RUNETYPE_FROST  = 3;
local RUNETYPE_DEATH  = 4;

function FillRunesInfo()
    runes = {
        BLOOD  = { Rem = 0, Count = 0, FullCount = 0 },
        UNHOLY = { Rem = 0, Count = 0, FullCount = 0 },
        FROST  = { Rem = 0, Count = 0, FullCount = 0 },
        DEATH  = { Rem = 0, Count = 0, FullCount = 0 },
        Total  = 0,
        Power  = UnitPower("player", SPELL_POWER_RUNIC_POWER),
    };

    for slot = 1, 6 do
        local runeType        = GetRuneType(slot);
        local runeCount       = GetRuneCount(slot);
        local start, duration = GetRuneCooldown(slot);
        local rune_name       = RUNE_MAPPING[runeType];

        runes.Total = runes.Total + runeCount;

        runes[rune_name].Rem       = (start + duration) - GetTime();
        runes[rune_name].Count     = runeCount + runes[rune_name].Count;
        runes[rune_name].FullCount = runeCount + runes[rune_name].FullCount;

        -- Руна сметри может быть использована в качестве любой из рун.
        -- надо тестить
        if runeType == RUNETYPE_DEATH then
            runes.BLOOD.FullCount  = runes.BLOOD.FullCount  + runeCount;
            runes.UNHOLY.FullCount = runes.UNHOLY.FullCount + runeCount;
            runes.FROST.FullCount  = runes.FROST.FullCount  + runeCount;
        end
        --print(rune_name.." Remains: "..runes[rune_name].Rem.." Count: "..runes[rune_name].Count);
    end
end
]]></Lua>
    <Rotation Name="Кровь">
      <HotKey Key="X" Modifier="Alt" />
      <Lua><![CDATA[
--if DebugMode then
--    AddonFrame:RegisterEvent("UI_ERROR_MESSAGE");
--    function EVENT_MODS.UI_ERROR_MESSAGE(msg)
--        print(msg);
--        print(format("Blood: %d Frost: %d Unholy: %d Death: %d",
--            runes.BLOOD.Count,
--            runes.FROST.Count,
--            runes.UNHOLY.Count,
--            runes.DEATH.Count
--        ));
--        print("===============");
--    end
--end
]]></Lua>
      <Ability Name="Смерть и разложение">
        <SpellID>43265</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMountedEx() or IsStealthed() then
    return true;
end

-- Перейти в стойку защиты
if GetSpecialization() == 1 and GetShapeshiftForm() ~= 1 then
    CastShapeshiftForm(1); -- blood
end

FillRunesInfo();

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

isInMeele  = IsSpellInRange(GetSpellInfo(45462), "target") == 1;
agroStatus = UnitThreatSituation("player") or 0;
playerHP   = HealthByPercent("player") or 1;
]]></Lua>
      </Ability>
      <Ability Name="Заморозка разума">
        <SpellID>47528</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useInterrupt and CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Кровь вампира">
        <SpellID>55233</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if playerHP < 30 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Костяной щит">
        <SpellID>49222</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not HasBuff("player", 49222) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Незыблемость льда">
        <SpellID>48792</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and playerHP <= 40 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Захват рун">
        <SpellID>48982</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>true</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if agroStatus > 2 and playerHP < 70 and isInMeele then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Танцующее руническое оружие">
        <SpellID>49028</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useCooldown and isInMeele and playerHP < 60;
]]></Lua>
      </Ability>
      <Ability Name="Вспышка болезни">
        <SpellID>77575</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local diseases = {
    55078, -- Кровавая чума
    55095, -- Озноб
};
if not HasDebuff(target, diseases, "PLAYER") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Удар чумы">
        <SpellID>45462</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Кровавая чума
if not HasDebuff("target", 55078, "PLAYER") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Ледяное прикосновение">
        <SpellID>45477</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not HasDebuff("target", 55095, "PLAYER") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Удар смерти">
        <SpellID>49998</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- local value = select(5, HasBuff("player", 158300));
-- local def_val = IsInRaid() and 100 or 50;
if playerHP < 85 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Кровоотвод">
        <SpellID>45529</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local blood = runes.BLOOD.FullCount;
local frost = runes.FROST.FullCount;
local unholy= runes.UNHOLY.FullCount;

if blood == 0 or unholy == 0 or frost == 0 then
    if select(2, HasBuff("player", 114851)) >= 5 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Жнец душ">
        <SpellID>114866</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not setAoE and HealthByPercent(target) <= 35 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Вскипание крови">
        <SpellID>50842</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele then
    if setAoE or HasBuff("player", 81141) or runes.BLOOD.Count > 1 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Лик смерти">
        <SpellID>47541</SpellID>
        <Target>Target</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Усиление рунического оружия">
        <SpellID>47568</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and isInMeele and runes.Total == 0 and playerHP < 50 then
    return true;
end
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Лед">
      <HotKey Key="Z" Modifier="Alt" />
      <Lua><![CDATA[
simulacrSpellTable = {
    0, -- Добавить сюда список заклинаний
};
]]></Lua>
      <Ability Name="Смерть и разложение">
        <SpellID>43265</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMountedEx() or IsStealthed() then
    return true;
end

FillRunesInfo();

-- Если в слоте под левую руку ничего нет - значит двухручка (КА)
isTwoHand = not GetInventoryItemID("player", INVSLOT_OFFHAND);
isInMeele = IsSpellInRange(GetSpellInfo(49143), "target") == 1;
]]></Lua>
      </Ability>
      <Ability Name="Заморозка разума">
        <SpellID>47528</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useInterrupt and CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Темный симулякр">
        <SpellID>77606</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>true</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
for _, spellId in ipairs(simulacrSpellTable) do
    local endTime,_,castId = UnitCastingInfo(target);
    if spellId == castId then
        if (((endTime / 1000) - GetTime()) - AddonFrame.ping) < 2 then
            return true
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Кровоотвод">
        <SpellID>45529</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local frost = runes.FROST.FullCount;
local unholy= runes.UNHOLY.FullCount;

if unholy == 0 or frost == 0 then
    if select(2, HasBuff("player", 114851)) >= 5 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Ледяной столб">
        <SpellID>51271</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and useCooldown then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Воскрешение мертвых">
        <SpellID>46584</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and useCooldown then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Вспышка болезни">
        <SpellID>77575</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local diseases = {
    55078, -- Кровавая чума
    55095, -- Озноб
};
if select(3, HasDebuff(target, diseases, "PLAYER")) < 3 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Ледяной столб">
        <SpellID>51271</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and useCooldown then
    return runes.Total < 2;
end
]]></Lua>
      </Ability>
      <Ability Name="Усиление рунического оружия">
        <SpellID>47568</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and useCooldown then
    return runes.Total < 2;
end
]]></Lua>
      </Ability>
      <Ability Name="Жнец душ">
        <SpellID>130735</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if HealthByPercent(target) < 35 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Воющий ветер">
        <SpellID>49184</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if setAoE then
    -- Используем только при АОЕ или когда надо обновить болезнь
    return select(3, HasDebuff(target, 55095, "PLAYER")) < 2; -- Озноб
end
]]></Lua>
      </Ability>
      <Ability Name="Удар чумы">
        <SpellID>45462</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return select(3, HasDebuff(target, 55078, "PLAYER")) < 3 -- Кровавая чума
]]></Lua>
      </Ability>
      <Ability Name="Ледяной удар (1H)">
        <SpellID>49143</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Для одноручного оружия и при проке "Машина для убийств"
if not isTwoHand and HasBuff("player", 51124) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Воющий ветер (1H)">
        <SpellID>49184</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not isTwoHand;
]]></Lua>
      </Ability>
      <Ability Name="Уничтожение">
        <SpellID>49020</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Ледяной удар">
        <SpellID>49143</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Для двуручного оружия или при максимуме рунической силы
return isTwoHand or runes.Power > 90;
]]></Lua>
      </Ability>
      <Ability Name="Воющий ветер (2H)">
        <SpellID>49184</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Используем с двуручным оружием при проке "59057 - Инея"
if isTwoHand and HasBuff("player", 59057) then
    return true;
end
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Нечестивость">
      <HotKey Key="C" Modifier="Alt" />
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Смерть и разложение">
        <SpellID>43265</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Кровоотвод">
        <SpellID>45529</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if runes.Death.Count < 1 then
    if (select(2, HasBuff("player", 114851)) or 0) >= 5 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Вспышка болезни">
        <SpellID>77575</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local diseases = {
    59879, -- Кровавая чума
    59921, -- Озноб
};
if not HasDebuff("target", diseases, "PLAYER") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Удар чумы">
        <SpellID>45462</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not (HasDebuff("target", 59879, "PLAYER")        -- Кровавая чума
    and HasDebuff("target", 59921, "PLAYER")) then  -- Озноб
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Жнец душ">
        <SpellID>130736</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if runes.Frost.Count > 0 and HealthByPercent("target") < 35 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Темное превращение">
        <SpellID>63560</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
      </Ability>
      <Ability Name="Лик смерти">
        <SpellID>47541</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if runes.Power > 40 or HasBuff("player", 49530) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Удар разложения">
        <SpellID>85948</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if runes.Frost.Count > 0 and runes.Blood.Count > 0 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Удар плети">
        <SpellID>55090</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if runes.Frost.Count > 0 then
    return true;
end
]]></Lua>
      </Ability>
    </Rotation>
  </Profile>
  <Profile Class="Shaman">
    <Rotation Name="Стихии">
      <HotKey Key="X" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = false;
useCooldown = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() then
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

isInRange = IsSpellInRange(GetSpellInfo(403), "target") == 1;

FillPartyTables(8004);
]]></Lua>
      </Ability>
      <Ability Name="Щит молний">
        <SpellID>324</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not HasBuff("player", 324) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Пронизывающий ветер">
        <SpellID>57994</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Исцеляющий всплеск">
        <SpellID>8004</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
--if UnitExists("mouseover") and HealthByPercent("mouseover") < 70 and UnitIsFriend("player", "mouseover") then
--    return true;
--end
--for _, member in ipairs(members) do
--    if member.HP < 70 then
--        --print(UnitName(member.Unit), member.HP);
--        return member.Unit;
--    end
--end
]]></Lua>
      </Ability>
      <Ability Name="Опаляющий тотем">
        <SpellID>3599</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not setAoE and isInRange and UnitExists("target") and not GetTotemInfo(1) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Перерождение">
        <SpellID>165339</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if isInRange and useCooldown then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Земной шок">
        <SpellID>8042</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if select(2, HasBuff("player", 324)) > 14 or UnitLevel("player") < 20 then
    if select(3, HasDebuff(target, 8050, "PLAYER")) < 5 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Огненный шок">
        <SpellID>8050</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if select(3, HasDebuff(target, 8050, "PLAYER")) <= 3 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Высвободить чары стихий">
        <SpellID>73680</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Освобожденная ярость
if IsTalentSpell(GetSpellInfo(117012)) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Выброс лавы">
        <SpellID>51505</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if setAoE and HasBuff("player", 77756) then
    return true;
elseif HasBuff("player", 77756) or not IS_MOVING then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Удар духов стихии">
        <SpellID>117014</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Цепная молния">
        <SpellID>421</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
return setAoE;
]]></Lua>
      </Ability>
      <Ability Name="Молния">
        <SpellID>403</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Совершенствование">
      <HotKey Key="Z" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = false;
useCooldown = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() then
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

isInMeele = IsSpellInRange(GetSpellInfo(8050), "target") == 1;
]]></Lua>
      </Ability>
      <Ability Name="Пронизывающий ветер">
        <SpellID>57994</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Щит молний">
        <SpellID>324</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not HasBuff("player", 324) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Опаляющий тотем">
        <SpellID>3599</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and UnitExists("target") then
    if not GetTotemInfo(1) and select(3, HasBuff("player", 77657)) < 3 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Кольцо огня">
        <SpellID>1535</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if setAoE and HasDebuff(target, 8050, "PLAYER") then
    return isInMeele;
end
]]></Lua>
      </Ability>
      <Ability Name="Молния">
        <SpellID>403</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if select(2, HasBuff("player", 53817)) > 4 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Удар бури">
        <SpellID>17364</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Огненный шок">
        <SpellID>8050</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if select(3, HasDebuff(target, 8050, "PLAYER")) <= 3 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Вскипание лавы">
        <SpellID>60103</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Земной шок">
        <SpellID>8050</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Цепная молния">
        <SpellID>421</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if setAoE and select(2, HasBuff("player", 53817)) > 0 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Молния">
        <SpellID>403</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if select(2, HasBuff("player", 53817)) > 0 then
    return true;
end
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Исцеление">
      <HotKey Key="C" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = false;
useAutoDispell = true;
useCooldown = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        end
    elseif modifier == "RCTRL" then
        if useAutoDispell then
            useAutoDispell = false;
            AddonFrame.print("|cffff0000Автодиспел выключен", true);
        else
            useAutoDispell = true;
            AddonFrame.print("|cff00ff00Автодиспел включен", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftShift) or IsMounted() or IsStealthed() then
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

FillPartyTables(8004);
]]></Lua>
      </Ability>
      <Ability Name="Целительный ливень">
        <SpellID>73920</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
-- Колеcико мышки
return IsMouseButtonDown(3);
]]></Lua>
      </Ability>
      <Ability Name="Водяной щит">
        <SpellID>52127</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not HasBuff("player", 52127) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Щит земли">
        <SpellID>974</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
for _,member in ipairs(members) do
    if member.Agro > 2 and member.IsTank then
        if select(3, HasBuff(member.Unit, 974, "PLAYER")) > 10 then
            return;
        end
    end
end

-- Накладываем щит земли на танка с агро
for _,member in ipairs(members) do
    if member.Agro > 2 and member.IsTank then
        return member.Unit;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Пронизывающий ветер">
        <SpellID>57994</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Очищение духа">
        <SpellID>77130</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsMouseButtonDown(5) then
    if UnitExists("mouseover") then
        return "mouseover";
    end
end
if useAutoDispell then
    return GetDispellInfo("HEAL");
end
]]></Lua>
      </Ability>
      <Ability Name="Цепное исцеление">
        <SpellID>1064</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if LowHP.H70 > 2 then
    return members[1].Unit;
end
]]></Lua>
      </Ability>
      <Ability Name="Быстрина">
        <SpellID>61295</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
for _,member in ipairs(members) do
    if member.HP < 70 or (member.IsTank and member.Agro > 2) then
        if not HasBuff(member.Unit, 61295, "PLAYER") then
            return member.Unit;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Исцелающий всплеск">
        <SpellID>8004</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if members[1].HP < 60 then
    return members[1].Unit;
end
]]></Lua>
      </Ability>
      <Ability Name="Тотем исцеляющего потока">
        <SpellID>5394</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if LowHP.H80 > 2 and not GetTotemInfo(3) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Опаляющий тотем">
        <SpellID>3599</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not setAoE and isInRange and UnitExists("target") and not GetTotemInfo(1) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Дух предков">
        <SpellID>2008</SpellID>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if UnitIsDead("mouseover") and not UnitAffectingCombat("player") and UnitIsPlayer("mouseover") then
    return true;
end
]]></Lua>
      </Ability>
    </Rotation>
  </Profile>
  <Profile Class="Mage">
    <Lua><![CDATA[
setAoE = false;
useCooldown = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
    <Rotation Name="Огонь">
      <HotKey Key="Z" Modifier="Alt" />
      <Lua><![CDATA[
igniteDamage = 0;     -- Урон от тика доты Воспламенение (12654)
pyroCrit     = nil;   -- Было ли заклинание Огненная глыба (11366) критическим

function EVENT_MODS.COMBAT_LOG_EVENT_UNFILTERED(timestamp, subEvent, hideCaster,
          sourceGUID,srcName,  sourceFlags,sourceFlags2,
          destGUID,  destName, destFlags,  destFlags2,
          spellId,   spellName,spellSchool,amount,   overkill,school,
          resisted,  blocked,  absorbed,   critical, glancing,crushing)

    if subEvent == "SPELL_PERIODIC_DAMAGE" then
        if UnitGUID("player") == sourceGUID and destGUID == UnitGUID("target") then
            -- Воспламенение
            if spellId == 12654 then
                igniteDamage = amount or 0;
                if DebugMode then
                    AddonFrame:print("Воспламенение (12654) - "..tostring(amount));
                end
            end
        end
    end

    if subEvent == "SPELL_DAMAGE" then
        if UnitGUID("player") == sourceGUID and destGUID == UnitGUID("target") then
            -- Огненная глыба
            if spellId == 11366 then
                pyroCrit = critical;
                if DebugMode and critical then
                    print("|cff00ff00 Крит: Огненная глыба (11366) - "..tostring(amount));
                end
            end
        end
    end
end
]]></Lua>
      <Ability Name="Руна мощи">
        <SpellID>116011</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkRightAlt);
]]></Lua>
      </Ability>
      <Ability Name="Огненный столб">
        <SpellID>2120</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() then
    return true;
end

isInRange = IsSpellInRange(GetSpellInfo(133), "target") == 1;

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

-- Самоцвет маны
if PowerByPercent("player") < 50 then
    UseItemById(36799);
end

-- Усли у нас есть прок Огненной глыбы!, преклащаем каст Огненного шара или Ожога
if UnitCastingInfo("player") == GetSpellInfo(133) or UnitCastingInfo("player") == GetSpellInfo(2943) then
    if HasBuff("player", 48108) then
        SpellStopCasting();
    end
end

if useCooldown then
    UseItemBySlot(INVSLOT_HAND);
    UseItemBySlot(INVSLOT_TRINKET1);
    UseItemBySlot(INVSLOT_TRINKET1);
end
]]></Lua>
      </Ability>
      <Ability Name="Замедленное падение">
        <SpellID>130</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- надо тестировать
if not IsFalling() then
    falingStartTime = 0;
elseif IsFalling() and (falingStartTime or 0) == 0 then
    falingStartTime = GetTime();
elseif GetTime() - (falingStartTime or 0) > 1 and not HasBuff("player", 130) then
    falingStartTime = 0;
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Антимагия">
        <SpellID>2139</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Зеркальное изображение">
        <SpellID>55342</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return isInRange and useCooldown;
]]></Lua>
      </Ability>
      <Ability Name="Живая бомба">
        <SpellID>44457</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsSpellInRange(GetSpellInfo(2948), target) == 1 then
    if not HasDebuff(target, ability.SpellId, "PLAYER") then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Огненная глыба">
        <SpellID>11366</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Огненная глыба! (48108)
if HasBuff("player", 48108) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Возгорание">
        <SpellID>11129</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Вешаем возгорание только после крита Огненной бомбы (и/или) наличия сильной доты.
-- Так же важно использовать возгорание под прок тринек
if useCooldown and (pyroCrit or igniteDamage > 100000) then
    if select(3, HasDebuff(target, 12654, "PLAYER")) > 3 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Пламенный взрыв">
        <SpellID>108853</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInRange and (HasBuff("player", 48107) or HasDebuff("target", 11129)) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Ожег">
        <SpellID>2948</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>Moving</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Огненный шар">
        <SpellID>133</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Чародейская гениальность">
        <SpellID>1459</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not HasBuff("player", 1459);
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Лед">
      <HotKey Key="X" Modifier="Alt" />
      <Ability Name="Руна мощи">
        <SpellID>116011</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkRightAlt);
]]></Lua>
      </Ability>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() then
    return true;
end

-- ???
if HasBuff("player", 87959) then
    return true;
end

isInRange = IsSpellInRange(GetSpellInfo(116), "target") == 1;

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

-- Холод элементаля (33395)
if IsMouseButtonDown(4) then
    if SpellCD(33395) == 0 then
        CastSpellByID(33395);
        CameraOrSelectOrMoveStart();
        CameraOrSelectOrMoveStop();
        CastSpellByID(33395);
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Замедленное падение">
        <SpellID>130</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- надо тестировать
if not IsFalling() then
    falingStartTime = 0;
elseif IsFalling() and (falingStartTime or 0) == 0 then
    falingStartTime = GetTime();
elseif GetTime() - (falingStartTime or 0) > 1 and not HasBuff("player", 130) then
    falingStartTime = 0;
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Снежная Буря">
        <SpellID>10</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Антимагия">
        <SpellID>2139</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Зеркальное изображение">
        <SpellID>55342</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return isInRange and useCooldown;
]]></Lua>
      </Ability>
      <Ability Name="Щит заклинателя">
        <SpellID>1463</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not HasBuff("player", 1463);
]]></Lua>
      </Ability>
      <Ability Name="Ледяная преграда">
        <SpellID>11426</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not HasBuff("player", 11426);
]]></Lua>
      </Ability>
      <Ability Name="Живая бомба">
        <SpellID>44457</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsSpellInRange(GetSpellInfo(116), target) == 1 then
    if not HasDebuff(target, ability.SpellId, "PLAYER") then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Стрела ледяного огня">
        <SpellID>44614</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if HasBuff("player", 44549) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Ледяное копье">
        <SpellID>30455</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if HasBuff("player", 112965) or (IS_MOVING and not HasBuff("player", 108839)) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Плавучая льдина">
        <SpellID>108839</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>Moving</IsMovingCheck>
        <Lua><![CDATA[
if isInRange then
    local bufs = {
        44549,  -- Заморозка мозгов
        108839, -- Плавучая льдина
        112965, -- Ледяные пальцы
    };
    if not HasBuff("player", bufs) then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Ледяная стрела">
        <SpellID>116</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Чародейская гениальность">
        <SpellID>1459</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not HasBuff("player", 1459);
]]></Lua>
      </Ability>
      <Ability Name="Морозный доспех">
        <SpellID>7302</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>true</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
return not HasBuff("player", 7302);
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Тайная магия">
      <HotKey Key="C" Modifier="Alt" />
    </Rotation>
  </Profile>
  <Profile Class="Warlock">
    <Lua><![CDATA[
setAoE = false;
useCooldown = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
    <Rotation Name="Демонология">
      <HotKey Key="X" Modifier="Alt" />
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Пауза в ротации
if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() then
    return true;
end


if IsMounted() then
    return true;
end

power2 = UnitPower("player", SPELL_POWER_DEMONIC_FURY);
isInRange = IsSpellInRange(GetSpellInfo(172), "target") == 1;

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end
]]></Lua>
      </Ability>
      <Ability Name="Метаморфоза">
        <SpellID>103958</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetShapeshiftForm() ~= 1 and power2 > 150 then
    if power2 > 990 or select(3, HasDebuff("target", 603, "PLAYER")) < 2 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Рок">
        <SpellID>603</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInRange then
    if GetShapeshiftForm() == 1 then
        if select(3, HasDebuff("target", 603, "PLAYER")) < 2 then
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Порча (Target)">
        <SpellID>172</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetShapeshiftForm() ~= 1 then
    if select(3, HasDebuff("target", 172, "PLAYER")) < 2 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Порча (Focus)">
        <SpellID>172</SpellID>
        <Target>Focus</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetShapeshiftForm() ~= 1 then
    if select(3, HasDebuff("focus", 172, "PLAYER")) < 2 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Порча (Mouseover)">
        <SpellID>172</SpellID>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetShapeshiftForm() ~= 1 then
    if select(3, HasDebuff("mouseover", 172, "PLAYER")) < 2 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Рука Гул'дана">
        <SpellID>105174</SpellID>
        <Target>Target</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not HasBuff("target", 47960) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Ожег души">
        <SpellID>6353</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if HasBuff("target", 122351) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Стрела тьмы">
        <SpellID>686</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Узы тьмы">
        <SpellID>109773</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if UnitLevel("player") > 81 and not HasBuff("player", 109773) then
    return true;
end
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Разрушение">
      <HotKey Key="Z" Modifier="Alt" />
      <Lua><![CDATA[
useChaosBold = true;
]]></Lua>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Пауза в ротации
if IsModKeyDown(mkLeftAlt) then
    return true;
end

isInRange = IsSpellInRange(GetSpellInfo(17962), "target") == 1;

-- заклинание не проходит проверку на IsUsableSpell
if not setAoE and HasBuff("player", 108683) then
    CastSpellByName(GetSpellInfo(108683));
end
]]></Lua>
      </Ability>
      <Ability Name="Неистовство тьмы">
        <SpellID>30283</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsMouseButtonDown(3) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Удар кнутом">
        <SpellID>119909</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsMouseButtonDown(3) then
    local cd = SpellCD(30283);
    if cd > 0 and cd < 28 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Огненный ливень">
        <SpellID>5740</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Пауза">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsMounted() then
    return true;
end

power2           = UnitPower("player", SPELL_POWER_BURNING_EMBERS);
FireAndBrimstone = HasBuff("player", 108683); -- огонь и сера
ChaosCount       = select(2, HasBuff("player", 80240));-- хаос
RainOfFire       = HasBuff("player", 104232); -- огненный ливень

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

-- Установка пета в указанную позицию
if IsMouseButtonDown(4) then
    PetMoveTo();
    CameraOrSelectOrMoveStart();
    CameraOrSelectOrMoveStop();
    PetMoveTo();
end

------------------------------------------------
--    CD
------------------------------------------------

-- Копим угли
if useCooldown and SpellCD(113858) < (40 - (power2 * 10)) then
    useChaosBold = false;
end

-- Сливаем угли
if useCooldown and HasBuff("player", 113858) then
    UseItemBySlot(INVSLOT_TRINKET1);
    UseItemBySlot(INVSLOT_TRINKET1);
    UseItemBySlot(INVSLOT_HAND);
    useChaosBold = true;
end
]]></Lua>
      </Ability>
      <Ability Name="Углевод">
        <SpellID>114635</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if power2 > 0 and HealthByPercent("player") < 60 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Запрет чар">
        <SpellID>119910</SpellID>
        <Target>Target</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
--return CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Запрет чар">
        <SpellID>132409</SpellID>
        <Target>Target</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
--return CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Ожог тьмы">
        <SpellID>17877</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
--if power2 > 0 and useChaosBold and HealthByPercent(target) < 20 then
--    return true;
--end
]]></Lua>
      </Ability>
      <Ability Name="Черная душа: Изменчивость">
        <SpellID>113858</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
--if isInRange and useCooldown and power2 > 3 then
--    return true;
--end
]]></Lua>
      </Ability>
      <Ability Name="Хаос">
        <SpellID>80240</SpellID>
        <Target>Focus</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if power2 > 0 and not RainOfFire and not FireAndBrimstone and ChaosCount == 0 then
    if UnitExists("target")
        and not UnitIsUnit(target, "target")
        and UnitIsEnemy("target", "player") then
        if not HasDebuff(target, 80240, "PLAYER") then
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Хаос">
        <SpellID>80240</SpellID>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if power2 > 0 and not RainOfFire and not FireAndBrimstone and ChaosCount == 0 then
    if UnitExists("target")
        and not (UnitIsUnit(target, "target") or UnitIsUnit(target, "focus"))
        and UnitIsEnemy("target", "player") then
        if not HasDebuff(target, 80240, "PLAYER") then
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Огонь и сера">
        <SpellID>108683</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInRange and power2 > 0 and setAoE and not HasBuff("player", 108683) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Жертвенный огонь (AOE)">
        <SpellID>108686</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>true</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if UnitHealth(target) < UnitHealthMax("player") then
    return;
end

if setAoE and FireAndBrimstone and power2 > 0 and isInRange and ChaosCount < 3
    and IsSpellKnown(108683) then
    if select(3, HasDebuff(target, 108686, "PLAYER")) < 3 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Жертвенный огонь">
        <SpellID>348</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>true</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if IsSpellInRange(GetSpellInfo(17962), target) == 1 then
    if select(3, HasDebuff(target, ability.SpellId, "PLAYER")) < 3 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Поджигаие">
        <SpellID>17962</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInRange and ChaosCount < 3 then
    -- Если нету бафа обратного потока
    if not HasBuff("player", 117828) and GetSpellCount(GetSpellInfo(17962)) == 2 then
        if FireAndBrimstone then
            return power2 > 1;
        else
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Стрела хаоса">
        <SpellID>116858</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if useChaosBold and power2 > 0 and not FireAndBrimstone then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Поджигаие">
        <SpellID>17962</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInRange and ChaosCount < 3 then
    -- Если нету бафа обратного потока
    if not HasBuff("player", 117828) then
        if FireAndBrimstone then
            return power2 > 1;
        else
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Испепеление">
        <SpellID>29722</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
return isInRange;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Колдовство">
      <HotKey Key="C" Modifier="Alt" />
      <Ability Name="Неистовство тьмы">
        <SpellID>30283</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return IsMouseButtonDown(3);
]]></Lua>
      </Ability>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Пауза в ротации

if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() then
    return true;
end

isInRange = IsSpellInRange(GetSpellInfo(172), "target") == 1;
soulShards = UnitPower("player", SPELL_POWER_SOUL_SHARDS);

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

-- Установка пета в указанную позицию
if IsMouseButtonDown(4) then
    PetMoveTo();
    CameraOrSelectOrMoveStart();
    CameraOrSelectOrMoveStop();
    PetMoveTo();
end
]]></Lua>
      </Ability>
      <Ability Name="Запрет чар">
        <SpellID>132409</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if CheckInterrupt(target) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Черная душа: Страдание">
        <SpellID>113860</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and not HasBuff("player", 113860) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Семя порчи">
        <SpellID>27243</SpellID>
        <Target>Target</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>true</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if setAoE and isInRange and soulShards > 0 and SpellCD(74434) == 0 then
    if UnitExists(target)
        and UnitCanAttack("player", target)
        and not UnitIsDeadOrGhost(target)
        and not UnitIsFriend("player", target) then
        if not HasDebuff(target, ability.SpellId, "PLAYER") then
            -- Горящая душа (без ГКД)
            CastSpellByName(GetSpellInfo(74434));
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Обмен душ">
        <SpellID>86121</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <Target>Boss1</Target>
        <Target>Boss2</Target>
        <Target>Boss3</Target>
        <Target>Boss4</Target>
        <Target>Boss5</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
--[[

Не использовать!!!
Сильно большой расход осколков.

if soulShards > 1 and SpellCD(74434) == 0 then
    local dotList = {
        980,    -- Агония
        172,    -- Порча
        30108,  -- Нестабильное колдовство
    };
    if IsSpellInRange(GetSpellInfo(86121), target) == 1 then
        -- Если нету ни одного дебафа
        -- если у цели меньше 20% здоровья
        -- если мы двигаемся
        if HealthByPercent("target") <= 20 or IS_MOVING then
            -- Проверяем только "Нестабильное колдовство"
            -- так как маленькая продолжительность и есть время каста
            -- так же не будем терять ДПС при перебежках.
            if select(3, HasDebuff(target, 30108, "PLAYER")) < 3 then
                -- Горящая душа (без ГКД)
                CastSpellByName(GetSpellInfo(74434));
                return true;
            end
        -- Накладываем через горящую душу когда дотов вообще нету
        elseif not HasDebuff(target, dotList, "PLAYER") then
            -- Горящая душа (без ГКД)
            CastSpellByName(GetSpellInfo(74434));
            return true;
        end
    end
end
]]
]]></Lua>
      </Ability>
      <Ability Name="Нестабильное колдовство">
        <SpellID>30108</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <Target>Boss1</Target>
        <Target>Boss2</Target>
        <Target>Boss3</Target>
        <Target>Boss4</Target>
        <Target>Boss5</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>true</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if select(3, HasDebuff(target, ability.SpellId, "PLAYER")) < 4 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Агония">
        <SpellID>980</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <Target>Boss1</Target>
        <Target>Boss2</Target>
        <Target>Boss3</Target>
        <Target>Boss4</Target>
        <Target>Boss5</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if select(3, HasDebuff(target, ability.SpellId, "PLAYER")) < 7 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Порча">
        <SpellID>172</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <Target>Boss1</Target>
        <Target>Boss2</Target>
        <Target>Boss3</Target>
        <Target>Boss4</Target>
        <Target>Boss5</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if select(3, HasDebuff(target, ability.SpellId, "PLAYER")) < 5 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Блуждающий дух">
        <SpellID>48181</SpellID>
        <Target>Target</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>true</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if soulShards > 0 then
    if not HasDebuff(target, ability.SpellId, "PLAYER") then
        if  select(3, HasDebuff(target, 980,   "PLAYER")) > 7      -- Агония
        and select(3, HasDebuff(target, 172,   "PLAYER")) > 7      -- Порча
        and select(3, HasDebuff(target, 30108, "PLAYER")) > 7 then -- Нестабильное колдовство
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Жизнеотвод">
        <SpellID>1454</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if PowerByPercent("player", SPELL_POWER_MANA) < 60
    and HealthByPercent("player") > 80 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Похищение души">
        <SpellID>103103</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Узы тьмы">
        <SpellID>109773</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not HasBuff("player", 109773) then
    return true;
end
]]></Lua>
      </Ability>
    </Rotation>
  </Profile>
  <Profile Class="Monk">
    <Lua><![CDATA[
useCooldown = true;
]]></Lua>
    <Rotation Name="Танцующий с ветром">
      <HotKey Key="C" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = false;
useCooldown = true;

ftable = { };

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00 Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000 AOE", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end

function EVENT_MODS.COMBAT_LOG_EVENT_UNFILTERED(timestamp, subEvent, hideCaster,
          sourceGUID,srcName,  sourceFlags,sourceFlags2,
          destGUID,  destName, destFlags,  destFlags2,
          spellId,   spellName,spellSchool,amount,   overkill,school,
          resisted,  blocked,  absorbed,   critical, glancing,crushing)
    if subEvent == "SPELL_CAST_SUCCESS" then
        if sourceGUID == UnitGUID("player") and spellId == 137639 then
            if ftable[destGUID] then
                ftable[destGUID] = nil;
            else
                ftable[destGUID] = GetTime();
            end
        end
    end
end
]]></Lua>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() then
    return true;
end

local stuned_debufs = { 115078 };

if HasDebuff("target", stuned_debufs) then
    StopAttack();
    PetStopAttack();
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

energy = UnitPower("player");     -- energy
chi    = UnitPower("player",  12); -- chi
]]></Lua>
      </Ability>
      <Ability Name="Буря, земля и огонь">
        <SpellID>137639</SpellID>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsModKeyDown(mkLeftShift) then

end
]]></Lua>
      </Ability>
      <Ability Name="Смертельное касание">
        <SpellID>115080</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if chi > 2 and not UnitIsPlayer("target") and UnitHealth("target") < UnitHealthMax("player") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Рука-копье">
        <SpellID>116705</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckInterrupt("target");
]]></Lua>
      </Ability>
      <Ability Name="Детоксикация">
        <SpellID>115450</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local monk_dispells = DISPELL_TABLE["MONK_NONE"];
if monk_dispells then
    for index = 1, 40 do
        local name, _,_,_, dispelType = UnitDebuff("player", index);
        if not name then break end
        if monk_dispells[dispelType] then
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Отвар тигриной силы">
        <SpellID>116740</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local stac = useCooldown and 9 or 17;
if select(2, HasBuff("player", 125195)) > stac and SpellCD(107428) < 2 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Порыв нефритового верта">
        <SpellID>116847</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return setAoE;
]]></Lua>
      </Ability>
      <Ability Name="Лапа тигра">
        <SpellID>100787</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if chi > 0 and select(3, HasBuff("player", 125359)) < 2 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Удар восходящего солнца">
        <SpellID>107428</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Нокаутирующий удар">
        <SpellID>100784</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if HasBuff("player", 116768) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Волна ци">
        <SpellID>115098</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Неистовые кулаки">
        <SpellID>113656</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if chi > 2 and energy < 40 and SpellCD(107428) > 3 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Нокаутирующий удар">
        <SpellID>100784</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Лапа тигра">
        <SpellID>100787</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if chi > 1 or HasBuff("player", 118864) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Будоражущий отвар">
        <SpellID>115288</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if energy < 40 and chi < 3 and IsSpellInRange(GetSpellInfo(100787), "target") == 1 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Устранение вреда">
        <SpellID>115072</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if UnitAffectingCombat("player") and HealthByPercent("player") < 75 then
    return true;
end

if not UnitAffectingCombat("player") and IsInRaid() and chi < 5 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Дзуки">
        <SpellID>100780</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Хмелевар">
      <HotKey Key="Z" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = false;
useCooldown = true;
useInterrupt = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00 Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000 AOE", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    elseif modifier == "RCTRL" then
        if useInterrupt then
            useInterrupt = false;
            AddonFrame.print("|cffff0000Автопрерывания выключены", true);
        else
            useInterrupt = true;
            AddonFrame.print("|cff00ff00Автопрерывания включены", true);
        end
    end
end
]]></Lua>
      <Ability Name="Хмельная дымка">
        <SpellID>115180</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsModKeyDown(mkLeftShift) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMountedEx() or IsStealthed() then
    return true;
end

isInMeele  = IsSpellInRange(GetSpellInfo(100787), "target") == 1;
agroStatus = UnitThreatSituation("player") or 0;
playerHP   = HealthByPercent("player");
energy     = UnitPower("player");     -- energy
chi        = UnitPower("player", 12); -- chi

additionalChi = IsSpellKnown(115396) and 1 or 0;

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end
]]></Lua>
      </Ability>
      <Ability Name="Целительная сфера">
        <SpellID>115460</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsModKeyDown(mkRightAlt) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Смертельное касание">
        <SpellID>115080</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if chi > 2 and not UnitIsPlayer("target") and
    UnitHealth("target") < UnitHealthMax("player") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Рука-копье">
        <SpellID>116705</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useInterrupt and CheckInterrupt("target");
]]></Lua>
      </Ability>
      <Ability Name="Отвар неуловимости">
        <SpellID>115308</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if select(2, HasBuff("player", 128939)) > 9 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Очищающий отвар">
        <SpellID>119582</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- (124275) Легкое пошатывание
-- (124274) Умеренное пошатывание
-- (124273) Сильное пошатывание
-- Снимаем только при "Сильном пошатывании"
if chi > 0 and SpellCD(115295) > 10 and HasDebuff("player", 124273) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Защита">
        <SpellID>115295</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>true</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if agroStatus > 2 then
    local value = select(5, HasBuff("player", 158300));
    local defence = HasBuff("player", 115295);
    local def_val = IsInRaid() and 150 or 50;
    if not defence and (value >= def_val or playerHP < 40) then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Детоксикация">
        <SpellID>115450</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local monk_dispells = DISPELL_TABLE["MONK_NONE"];
if monk_dispells then
    for index = 1, 40 do
        local name, _,_,_, dispelType = UnitDebuff("player", index);
        if not name then break end
        if monk_dispells[dispelType] then
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Волна ци">
        <SpellID>115098</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Укрепляющий отвар">
        <SpellID>115203</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if playerHP < 40 and useCooldown then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Устранение вреда">
        <SpellID>115072</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if playerHP < 80 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Пламенное дыхание">
        <SpellID>115181</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and setAoE and chi > 2 then
    -- Хмельная дымка или перк "Усиленное пламенное дыхание"
    if (HasDebuff("target", 123727, "PLAYER") or IsSpellKnown(157362))
    -- не должно быть дебафа от "Пламенное дыхание"
    and not HasDebuff("target", 123725, "PLAYER")
    -- на нас должны быть скрытые резервы
    and select(3, HasBuff("player", 115307)) > 5 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Порыв нефритового ветра">
        <SpellID>116847</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if setAoE and not HasBuff("player", 116847) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Удар кружкой">
        <SpellID>121253</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
      <Ability Name="Танцующий журавль">
        <SpellID>101546</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not IsPlayerSpell(116847) then
    if isInMeele and setAoE and chi > 2 then
        if HasDebuff("target", 123727, "PLAYER")
        and not HasDebuff("target", 123725, "PLAYER") then
            return false;
        end
    end
    if setAoE and isInMeele and energy >= 40 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Лапа тигра">
        <SpellID>100787</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not HasBuff("player", 125359) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Нокаутирующий удар">
        <SpellID>100784</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Если талант "Взрыв ци" выбран, тогда используем при АОЕ на 4 ци при соло на 3
-- Если талант не выбран - используем всегда
local needchi = setAoE and 3 or 2;
if not IsPlayerSpell(157676) or chi > needchi then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Дзуки">
        <SpellID>100780</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if SpellCD(121253) > 1 or energy > 80 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Лапа тигра">
        <SpellID>100787</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Ткач туманов">
      <HotKey Key="X" Modifier="Alt" />
    </Rotation>
  </Profile>
  <Profile Class="Druid">
    <Lua><![CDATA[
useCooldown = true;
setAoE      = nil;
isCat       = nil;
useAutoDispell = true;
]]></Lua>
    <Rotation Name="Лекарь">
      <HotKey Key="Z" Modifier="Alt" />
      <Lua><![CDATA[
useAutoDispell = true;

RegisterKeyHandler('F');
RegisterKeyHandler('R');
RegisterKeyHandler('T');

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "RCTRL" then
        if useAutoDispell then
            useAutoDispell = false;
            AddonFrame.print("|cffff0000Автодиспел выключен", true);
        else
            useAutoDispell = true;
            AddonFrame.print("|cff00ff00Автодиспел включен", true);
        end
    end
end

NOTIFY_CAST_TABLE[2908]   = "|cff15bd05>> Снимаю исступление!";
NOTIFY_CAST_TABLE[18562]  = "|cff00ff00>> Кастую Быстрое восстановление <<";
NOTIFY_CAST_TABLE[145518] = "|cff00ff00>> Кастую Сотворение <<";
]]></Lua>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- пауза
--if IsModKeyDown(mkLeftShift) then
--    for index = 1, NUM_WORLD_RAID_MARKERS do
--        if not IsRaidMarkerActive(index) then
--            PlaceRaidMarker(index);
--            break;
--        end
--    end
--    return true;
--end

FillPartyTables(774);
]]></Lua>
      </Ability>
      <Ability Name="Возрождение">
        <SpellID>20484</SpellID>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Перк "Усиленное возрождение" (157301)
if not IS_MOVING or (IS_MOVING and IsSpellKnown(157301)) then
    if not HasDebuff(target, 160029) then
        return IsModKeyDown(mkLeftShift) and UnitIsDeadOrGhost(target) and UnitIsPlayer(target);
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Оживление">
        <SpellID>50769</SpellID>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if not UnitAffectingCombat("player") and UnitIsPlayer(target)
    and (UnitIsDeadOrGhost(target) or UnitIsCorpse(target))
    and not HasDebuff(target, 160029) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Дикий гриб">
        <SpellID>145205</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Колеcико мышки
return IsMouseButtonDown(3);
]]></Lua>
      </Ability>
      <Ability Name="Пауза">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте или в форме или "Слился с тенью", тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() or HasBuff("player", 104270)
    or (GetShapeshiftForm() ~= 0 and GetShapeshiftForm() ~= 6) then
    return true;
end

-- Если кастуем спокойствие - тогда ничего не делаем
if UnitChannelInfo("player") then
    return true;
end

-- используем аксесуар на ману, только в форме исцеления (0)
if PowerByPercent("player", SPELL_POWER_MANA) < 80 and GetShapeshiftForm() == 0 then
    UseItemBySlot(INVSLOT_TRINKET2);
end

if PowerByPercent("player", SPELL_POWER_MANA) < 70 and GetShapeshiftForm() == 0 then
    UseItemBySlot(INVSLOT_TRINKET1);
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

if LowHP.H50 > 3 and UnitAffectingCombat("player") then
    UseItemBySlot(INVSLOT_HAND); -- Нейронные пружины
end

if HasBuff("player", 106898) and GetShapeshiftForm() == 1 then
    CancelShapeshiftForm();
end
]]></Lua>
      </Ability>
      <Ability Name="Астаральный скачек">
        <SpellID>102280</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsKeyDown("R") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Тревожный рев">
        <SpellID>106898</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsKeyDown("T") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Гнев">
        <SpellID>5176</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
return IsModKeyDown(mkLeftShift);
]]></Lua>
      </Ability>
      <Ability Name="Природный целитель">
        <SpellID>88423</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsMouseButtonDown(5) then
    if UnitExists("mouseover") then
        return "mouseover";
    end
end
if useAutoDispell then
    return GetDispellInfo("HEAL");
end
]]></Lua>
      </Ability>
      <Ability Name="Железная кора">
        <SpellID>102342</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
for _,member in ipairs(members) do
    -- Железную кору используем только на танка
    if member.IsTank and member.HP < 30 then
        return member.Unit;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Дубовая кора">
        <SpellID>22812</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if HealthByPercent("player") < 25 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Умиротворение">
        <SpellID>2908</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckEnrage(target);
]]></Lua>
      </Ability>
      <Ability Name="Сила Природы">
        <SpellID>102693</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local member_count = IsInRaid() and LowHP.H50 or LowHP.H70;
if GetSpellCharges(102693) > 2 or member_count > 3 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Природная стремительность">
        <SpellID>132158</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return members[1].HP < 40;
]]></Lua>
      </Ability>
      <Ability Name="Целительное прикосновение">
        <SpellID>5185</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- 132158 Природная стремительность
-- Следующее заклинание используется мгновенно
-- и не требует затрат ресурсов
if HasBuff("player", 132158) then
    -- Природную стремительность используем
    -- если у кого-то меньше 40% здоровья
    -- тут поставим проверку с запасом, так на всякий случай
    if members[1].HP < 50 then
        return members[1].Unit;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Восстановление">
        <SpellID>8936</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>true</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- 16870 Ясность мысли
if IsKeyDown('F')
    and UnitExists("mouseover")
    and UnitHealth("mouseover") > 100 -- это хаковая проверка на призывных юнитов (гриб друида и т.п.)
    and UnitCanAssist("player", "mouseover") then
    return "mouseover";
end
if HasBuff("player", 16870) and UnitAffectingCombat("player") then
    -- Используем только под проком ясности мысли, в дереве хилим на ходу
    -- Хилим либо просевшие цели либо когда нам надо обновить Гармонию
    local harmonyRemains = select(3, HasBuff("player", 100977));
    if members[1].HP <= 70 or harmonyRemains < 4 then
        if (GetShapeshiftForm() == 6 or not IS_MOVING) then
            return members[1].Unit;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Быстрое восстановление">
        <SpellID>18562</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Либо обновляем Гармонию, либо хилим просевшую цель.
-- Проверяем только наличие бафа Омоложение
local harmonyRemains = select(3, HasBuff("player", 100977));
for _,member in ipairs(members) do
    if HasBuff(member.Unit, 774, "PLAYER") and (member.HP < 80 or harmonyRemains < 4) then
        print(member.Unit, UnitName(member.Unit), member.HP, harmonyRemains)
        return member.Unit;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Буйный рост">
        <SpellID>48438</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
-- Очень дорогой АОЕ-хил,
-- применять нужно только если в рейде просажено более 3х-5ти целей до 70% хп и ниже.
local count = IsInRaid() and 5 or 3;
local member_count = IsInRaid() and LowHP.H60 or LowHP.H70;

if UnitExists("mouseover") and IsMouseButtonDown(5) then
    return "mouseover";
elseif (member_count > count and UnitAffectingCombat("player"))
    or IsMouseButtonDown(5) then
    return members[1].Unit;
end
]]></Lua>
      </Ability>
      <Ability Name="Жизнецвет">
        <SpellID>33763</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Проверяем наличе уже повешенного жизнецвета
-- чтобы во время боя (при агро на 2х танках) жизнецвет не перекидывало с одного на другого.

-- Надо реализовать механизм переброса жизнецвета если 1 танк просел сильно а агро на 2х.

for _,member in ipairs(members) do
    if member.Agro > 2 and HasBuff(member.Unit, 33763, "PLAYER") then
        return;
    end
end

for _,member in ipairs(members) do
    if member.Agro > 2 and (not members.HasTank or member.IsTank) then
        if not HasBuff(member.Unit, 33763, "PLAYER") then
            return member.Unit;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Сотворение">
        <SpellID>145518</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local count = 0;

if IsMouseButtonDown(4) then
    return true;
end

for _,member in ipairs(members) do
    if member.HP < 40 and select(3, HasBuff(member.Unit, 774, "PLAYER")) > 4 then
        count = count + 1;
        if count > 3 then
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Омоложение">
        <SpellID>774</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local hasGermination = IsSpellKnown(155675); -- Зарождеине (Талант)

if IsModKeyDown(mkLeftControl)
    and UnitExists("mouseover")
    and UnitHealth("mouseover") > 100 -- это хаковая проверка на призывных юнитов (гриб друида и т.п.)
    and UnitCanAssist("player", "mouseover") then
    if not (HasBuff("mouseover", 774, "PLAYER")
        and (not hasGermination or HasBuff("mouseover", 155777, "PLAYER")))  then
        return "mouseover";
    end
end

-- ВАЖНО:
-- Накладыввя второй раз Омоложение при активном таланте "Зарождение" мы накладываем
-- бафф "155777 - Зарождение", которое не обновляет время действия "774 - Омоложения".
-- Да и вообще бафы друг друга не обновляют. 156954
if IsModKeyDown(mkLeftControl) or UnitAffectingCombat("player") then
    local hp_rej = IsInRaid() and 70 or 80;
    local hp_ger = IsInRaid() and 55 or 60;

    for _,member in ipairs(members) do
        if member.HP < hp_rej or member.Agro > 2 or IsModKeyDown(mkLeftControl) then
            local rejuvenation = HasBuff(member.Unit, 774,    "PLAYER"); -- Омоложение
            local germination  = HasBuff(member.Unit, 155777, "PLAYER"); -- Омоложение (Зарождение бафф)

            -- Накладываем хоту если есть талант "Зарождение" и меньше 60% здоровья
            if not rejuvenation or (hasGermination and not germination and
                (member.HP < hp_ger or member.IsTank)) then
                return member.Unit;
            end
        end
    end
 end
]]></Lua>
      </Ability>
      <Ability Name="Восстановление">
        <SpellID>8936</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if members[1].HP <= 30 then
    -- В дереве хилим на ходу
    if GetShapeshiftForm() == 6 or not IS_MOVING then
        return members[1].Unit;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Целительное прикосновение">
        <SpellID>5185</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if members[1].HP <= 60 then
    return members[1].Unit;
end
]]></Lua>
      </Ability>
      <Ability Name="Знак дикой природы">
        <SpellID>1126</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local params_buff = { 1126, 115921, 20217, 90363 };
if GetShapeshiftForm() == 0 then
    for _,member in ipairs(members) do
        if member.IsInMyParty and UnitIsPlayer(member.Unit) then
            if not HasBuff(member.Unit, params_buff) then
                return true;
            end
        end
    end
end
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Страж">
      <HotKey Key="X" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = false;
isAltMod = true;
useCooldown = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if not setAoE then
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        else
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        end
    elseif modifier == "RALT" then
        if isAltMod then
            isAltMod = false;
            AddonFrame.print("|cffff0000Используется \'Дикая защита\'", true);
        else
            isAltMod = true;
            AddonFrame.print("|cff00ff00Используется \'Неистовое восстановление\'", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end
]]></Lua>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, или в инвизе или не в форме медведа или кота
if IsModKeyDown(mkLeftAlt) or IsMounted()
    or not (GetShapeshiftForm() == 2 or GetShapeshiftForm() == 1)
    or IsStealthed() then
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

agroStatus = UnitThreatSituation("player") or 0;
playerHP   = HealthByPercent("player");
isInMeele  = IsSpellInRange(GetSpellInfo(33917), "target") == 1;
isCat      = GetShapeshiftForm() == 2;

if isInMeele and useCooldown and SpellCD(33917) == 0 and UnitAffectingCombat("player") then
    UseItemBySlot(INVSLOT_HAND);
    UseItemBySlot(INVSLOT_TRINKET1);
    UseItemBySlot(INVSLOT_TRINKET2);
end
]]></Lua>
      </Ability>
      <Ability Name="Лобовая атака">
        <SpellID>106839</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckInterrupt("target");
]]></Lua>
      </Ability>
      <Ability Name="Целительное прикосновение">
        <SpellID>5185</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if playerHP < 80 and HasBuff("player", 145162) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Неистовое восстановление">
        <SpellID>22842</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not isCat then
    if playerHP < 80 and UnitPower("player") > 55 then
        return true;
    elseif playerHP < 30 and UnitPower("player") > 35 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Дикая защита">
        <SpellID>62606</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not isCat and playerHP < 60 and agroStatus > 0 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Дубовая кожа">
        <SpellID>22812</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and playerHP < 50 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Инстинкты выживания">
        <SpellID>61336</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not isCat and useCooldown and playerHP < 35 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Увечье">
        <SpellID>33917</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not isCat then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Взбучка">
        <SpellID>77758</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInMeele and not isCat then
    -- надо проверить ИД кровотечения.
    if setAoE or select(3, HasDebuff("target", 77758, "PLAYER")) < 2 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Трепка">
        <SpellID>6807</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- без ГКД
if not isCat and playerHP > 30 then
    -- зубы и когти
    if HasBuff("player", 135288) then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Раздавить">
        <SpellID>80313</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not isCat and select(2, HasDebuff("target", 33745, "PLAYER")) > 2 then
    if not HasBuff("player", 158792) then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Растерзать">
        <SpellID>33745</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not isCat then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Свирепый укус">
        <SpellID>22568</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isCat and UnitPower("player") > 30 and GetComboPoints("player") > 4 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Полоснуть">
        <SpellID>5221</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isCat then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Волшебный огонь">
        <SpellID>770</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return not isCat;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Сила зверя">
      <HotKey Key="C" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = false;
useCooldown = true;
useInterrupt = true;

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00 Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000 AOE", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    elseif modifier == "RCTRL" then
        if useInterrupt then
            useInterrupt = false;
            AddonFrame.print("|cffff0000Автопрерывания выключены", true);
        else
            useInterrupt = true;
            AddonFrame.print("|cff00ff00Автопрерывания включены", true);
        end
    end
end
]]></Lua>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMounted() or IsStealthed() then
    return true;
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

-- 69369d
isInMeele  = IsSpellInRange(GetSpellInfo(5221), "target") == 1;
energy     = UnitPower("player");
combopoint = GetComboPoints("player");
isBear     = GetShapeshiftForm() == 1;
isCat      = GetShapeshiftForm() == 2;
]]></Lua>
      </Ability>
      <Ability Name="Возрождение">
        <SpellID>20484</SpellID>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if HasBuff("player", 69369) then
    return UnitIsDeadOrGhost(target) and UnitIsPlayer(target);
end
]]></Lua>
      </Ability>
      <Ability Name="Снятие порчи">
        <SpellID>2782</SpellID>
        <Target>Focus</Target>
        <Target>Player</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return false;-- надо доработать
]]></Lua>
      </Ability>
      <Ability Name="Лобовая атака">
        <SpellID>106839</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return useInterrupt and CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Дикий рев">
        <SpellID>52610</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isCat and isInMeele and select(3, HasBuff("player", 52610)) < 2 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Тигриное неистовство">
        <SpellID>5217</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isCat and isInMeele and energy <= 35 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Берсерк">
        <SpellID>106952</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isCat and isInMeele and useCooldown and energy < 70 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Перевоплощение: Король джунглей">
        <SpellID>102543</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and isInMeele and HasBuff("player", 106952) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Целительное прикосновение">
        <SpellID>5185</SpellID>
        <Target>Focus</Target>
        <Target>Player</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if HasBuff("player", 69369) and HealthByPercent(terget) < 90 then
     return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Взбучка">
        <SpellID>106832</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isCat and isInMeele and setAoE then
    if select(3, HasDebuff("target", 106830, "PLAYER")) < 2 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Размах">
        <SpellID>106785</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isCat and setAoE and isInMeele then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Свирепый укус">
        <SpellID>22568</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isCat then
    local rip = select(3, HasDebuff("target", 1079, "PLAYER"));

    if combopoint > 4 and UnitExists("target")
        and (UnitHealth("target") * 2) < UnitHealthMax("player") then
        return true;
    elseif rip > 8 and energy >= 50 and combopoint > 4 then
        return true;
    elseif HealthByPercent("target") < 25 then
        if (rip < 2 and combopoint > 1) or (combopoint > 4 and energy >= 50) then
            return true;
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Разорвать">
        <SpellID>1079</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isCat then
    if combopoint > 4 and select(3, HasDebuff("target", 1079)) < 5 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Глубокая рана">
        <SpellID>1822</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isCat and select(3, HasDebuff("target", 1822)) < 3 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Полоснуть">
        <SpellID>5221</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isCat and combopoint < 5 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Неистовое восстановление">
        <SpellID>22842</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return isBear and UnitPower("player") > 40 and HealthByPercent("player") < 80;
]]></Lua>
      </Ability>
      <Ability Name="Увечте">
        <SpellID>33917</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return isBear;
]]></Lua>
      </Ability>
      <Ability Name="Взбучка">
        <SpellID>77758</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isBear and IsSpellInRange(GetSpellInfo(33917), "target") == 1 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Омоложеине">
        <SpellID>774</SpellID>
        <Target>Focus</Target>
        <Target>Player</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsSpellKnown(157280) -- перк "Усиленное омоложение"
    and HealthByPercent(target) < 80
    and not HasBuff(target, 774, "PLAYER") then
    return true;
end
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Баланс">
      <HotKey Key="V" Modifier="Alt" />
      <Lua><![CDATA[
setAoE = false;
useCooldown = true;
moonTargetList = { };

--RegisterKeyHandler('F');
RegisterKeyHandler('R');
RegisterKeyHandler('T');

function EVENT_MODS.MODIFIER_STATE_CHANGED(modifier, state)
    if state == 0 then return end; -- release key

    if modifier == "LCTRL" then
        if setAoE then
            setAoE = false;
            AddonFrame.print("|cff00ff00Одиночная цель", true);
        else
            setAoE = true;
            AddonFrame.print("|cffff0000AOE", true);
        end
    elseif modifier == "RSHIFT" then
        if useCooldown then
            useCooldown = false;
            AddonFrame.print("|cffff0000Кулдауны выключены", true);
        else
            useCooldown = true;
            AddonFrame.print("|cff00ff00Кулдауны включены", true);
        end
    end
end

-- Будем отслеживать был ли наложен дот во время усиления
function EVENT_MODS.COMBAT_LOG_EVENT_UNFILTERED(timestamp, subEvent, hideCaster,
          sourceGUID,srcName,  sourceFlags,sourceFlags2,
          destGUID,  destName, destFlags,  destFlags2,
          spellId,   spellName,spellSchool)
    if subEvent == "SPELL_CAST_SUCCESS" and sourceGUID == UnitGUID("player") then
        -- Солнечный/Лунный огонь
        if destGUID and (spellId == 93402 or spellId == 8921) then
            if HasBuff("player", 112071) then -- Парад планет
                moonTargetList[destGUID] = GetTime();
            end
        end
    end
end
]]></Lua>
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- если персонаж на маунте, тогда не выполняем ротацию дальше
if IsModKeyDown(mkLeftAlt) or IsMountedEx() or IsStealthed() then
    return true;
end

-- В бою мы должны всегда быть совой
if GetShapeshiftFormCooldown(4) == 0 and GetShapeshiftForm() ~= 4 then
    if UnitAffectingCombat("player") then
        CastShapeshiftForm(4);
    end
end

-- камень здоровья
if HealthByPercent("player") < 30 then
    UseItemById(5512);
end

isInRange = IsSpellInRange(GetSpellInfo(5176), "target") == 1;
power     = UnitPower("player", SPELL_POWER_ECLIPSE);

-- Чистим список целей обдотаных под бафом
for key, lastCast in pairs(moonTargetList) do
    if lastCast < GetTime() - 30 then
        moonTargetList[key] = nil;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Возрождение">
        <SpellID>20484</SpellID>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Перк "Усиленное возрождение" (157301)
if not IS_MOVING or (IS_MOVING and IsSpellKnown(157301)) then
    return IsModKeyDown(mkLeftShift) and UnitIsDeadOrGhost(target) and UnitIsPlayer(target);
end
]]></Lua>
      </Ability>
      <Ability Name="Астаральный скачек">
        <SpellID>102280</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsKeyDown("R") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Тревожный рев">
        <SpellID>106898</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsKeyDown("T") then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Дубовая кора">
        <SpellID>22812</SpellID>
        <Target>Player</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if HealthByPercent("player") < 25 then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Умиротворение">
        <SpellID>2908</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckEnrage(target);
]]></Lua>
      </Ability>
      <Ability Name="Дикий гриб">
        <SpellID>88747</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsMouseButtonDown(3) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Ураган">
        <SpellID>16914</SpellID>
        <Target>MouseLocation</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsModKeyDown(mkLeftControl) then
    -- Отключено
    return false;
end
]]></Lua>
      </Ability>
      <Ability Name="Солнечный столб">
        <SpellID>78675</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>true</CancelChannel>
        <CancelCasting>true</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return CheckInterrupt(target);
]]></Lua>
      </Ability>
      <Ability Name="Омоложение">
        <SpellID>774</SpellID>
        <Target>Focus</Target>
        <Target>Player</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local hp = 90;
if IsInRaid() then
    hp = 50;
elseif GetNumGroupMembers() < 6 and GetNumGroupMembers() > 1 then
    hp = 70;
end

if HealthByPercent(target) < hp and not HasBuff(target, 774) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Перевоплощение: Избранный Элуны">
        <SpellID>102560</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and isInRange then
    --if GetEclipseDirection() == "moon" and power < -70 then
        return true;
    --end
end
]]></Lua>
      </Ability>
      <Ability Name="Парад планет">
        <SpellID>112071</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
if useCooldown and isInRange then
    if GetEclipseDirection() == "moon" and power < -70 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Звездопад">
        <SpellID>48505</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if isInRange and setAoE then
    -- Доработать, правильно указать бонус
   -- if GetEclipseDirection() == "moon" and power < 0 then
        return true;
   -- end
end
]]></Lua>
      </Ability>
      <Ability Name="Лунный/Солнечный огонь">
        <SpellID>8921</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
local debuff = (power > 0) and 164815 or 164812; -- -100 lunar 0 solar 100
local sm_fire, _, sm_fire_rem = HasDebuff(target, debuff, "PLAYER");

-- Если парад планет подходит к концу, обновим доты (за 4 сек)
local celest,_,celest_rem = HasBuff("player", 112071);
if celest and celest_rem < 5 then
    -- Проверяем тольоко по Лунному огню, так как он короче по времени действия
    if select(3, HasBuff(target, 164815, "PLAYER")) < 15 then
        if (moonTargetList[UnitGUID(target)] or 0) < GetTime()-4 then
            print("Обновляем доту перед окончанием парада планет!");
            return true;
        end
    end
end

-- Под бафом "Парад планет" должны быть обе доты
if celest then
    if not HasDebuff(target, 164815, "PLAYER") or
       not HasDebuff(target, 164812, "PLAYER") then
       return true;
    end
end

local emprovement = (power > 0) and 171744 or 171743;
if not sm_fire or sm_fire_rem < 3 or (sm_fire_rem < 12 and HasBuff("player", emprovement)) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Звездный поток">
        <SpellID>78674</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not setAoE then
    -- Изначально Звездный поток имеет 3 заряда
    local charges = IS_MOVING and 1 or 2;
    local buffs = (power > 0) and 164545 or 164547; -- -100 lunar 0 solar 100
    if GetSpellCharges(78674) > charges
        or (select(3, HasBuff("player", 112071)) > 1 and not HasBuff("player", buffs)) then
        return true;
    elseif power < 0 and GetEclipseDirection() == "moon" then
        return not HasBuff("player", 164547); -- Лунное могущество
    elseif power > 0 and GetEclipseDirection() == "sun" then
        return not HasBuff("player", 164545); -- Солнечное могущество
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Лунный/Солнечный огонь">
        <SpellID>8921</SpellID>
        <Target>Target</Target>
        <Target>Focus</Target>
        <Target>Mouseover</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- Если двигаемся, спамим Лунный/Солнечный огонь
if IS_MOVING then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Гнев">
        <SpellID>5176</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
-- Используем только с бонусом солнечного затмения
-- -100 lunar 0 solar 100
if power > 0 then
    if GetEclipseDirection() == "sun" then
        return true;
    elseif GetEclipseDirection() == "moon" and power > 35 then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Звездный огонь">
        <SpellID>2912</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>NotMoving</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Фарм репы">
      <HotKey Key="N" Modifier="Alt" />
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if IsModKeyDown(mkLeftAlt) or IsMounted() or GetShapeshiftForm() ~= 0 then
    return true;
end

-- 64399 Боевой штандарт координации
UseItemById(64399);

TargetNearestEnemy();
]]></Lua>
      </Ability>
      <Ability Name="Лунный огонь">
        <SpellID>8921</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- and string.match(UnitName("target"), "^(.+).жных морей$")
if UnitExists("target") and not UnitIsDeadOrGhost("target") then
    if IS_MOVING or not HasDebuff("target", 8921) then
        return true;
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Гнев">
        <SpellID>5176</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
return true;
]]></Lua>
      </Ability>
    </Rotation>
  </Profile>
  <Profile Class="None">
    <Rotation Name="Малигос">
      <HotKey Key="M" Modifier="Alt Shift" />
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not UnitHasVehicleUI("player") then
    return true;
end

if IsModKeyDown(mkLeftAlt) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Дыхание жизни">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetPetActionCooldown(4) == 0 then
    if HealthByPercent("vehicle") < 40 and not HasBuff("vehicle", 57143) then
        if select(2, HasBuff("player", 57090)) > 3 then
            CastPetAction(4);
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Реанимация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetPetActionCooldown(3) == 0 then
    if     HealthByPercent("vehicle") < 90 then
        if select(2, HasBuff("vehicle", 57090)) < 1 then
            CastPetAction(3);
        end
    elseif HealthByPercent("vehicle") < 70 then
        if select(2, HasBuff("vehicle", 57090)) < 2 then
            CastPetAction(3);
        end
    elseif HealthByPercent("vehicle") < 50 then
        if select(2, HasBuff("vehicle", 57090)) < 3 then
            CastPetAction(3);
        end
    elseif HealthByPercent("vehicle") < 30 then
        if select(2, HasBuff("vehicle", 57090)) < 4 then
            CastPetAction(3);
        end
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Окутать пламенем">
        <SpellID>0</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>true</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if UnitExists("target") and UnitIsEnemy("player", "target")
    and GetPetActionCooldown(2) == 0 and GetComboPoints("vehicle") > 2 then
    CastPetAction(2, target);
end
]]></Lua>
      </Ability>
      <Ability Name="Пламенный шип">
        <SpellID>0</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if UnitExists("target") and UnitIsEnemy("player", "target")
    and GetPetActionCooldown(1) == 0 and GetComboPoints("vehicle") < 3 then
    CastPetAction(1, target);
end
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Серебряный авангард (Турнир)">
      <HotKey Key="T" Modifier="Alt Shift" />
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not UnitHasVehicleUI("player") then
    return true;
end

if IsModKeyDown(mkLeftAlt) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Защита">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetPetActionCooldown(4) == 0 then
    local col, rem = select(2, HasBuff("vehicle", 62552));
    if col < 3 or rem < 5 then
        CastPetAction(4);
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Удар по щиту">
        <SpellID>0</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- как-то определть дистанцию до цели
if UnitExists("target") and UnitIsEnemy("player", "target")
    and GetPetActionCooldown(2) == 0 then
    if select(2, HasBuff("target", 62719)) > 1 then
        CastPetAction(2);
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Рывок">
        <SpellID>0</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
-- как-то определть дистанцию до цели
if UnitExists("target") and UnitIsEnemy("player", "target")
    and GetPetActionCooldown(3) == 0 then
    if select(2, HasBuff("target", 62719)) <= 1 then
        CastPetAction(3);
    end
end
]]></Lua>
      </Ability>
      <Ability Name="Выпад">
        <SpellID>0</SpellID>
        <Target>Target</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if UnitExists("target") and UnitIsEnemy("player", "target")
    and GetPetActionCooldown(1) == 0 then
    CastPetAction(1);
end
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Ульдуар - Левиафан">
      <HotKey Key="C" Modifier="Alt Shift" />
      <Ability Name="Инициализация">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if not UnitHasVehicleUI("player") then
    return true;
end

if IsModKeyDown(mkLeftAlt) then
    return true;
end
]]></Lua>
      </Ability>
      <Ability Name="Бросок валуна">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetPetActionCooldown(1) == 0 then
    CastPetAction(1);
end
]]></Lua>
      </Ability>
      <Ability Name="Бросок бочки колчедана">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetPetActionCooldown(2) == 0 then
    CastPetAction(2);
end
]]></Lua>
      </Ability>
      <Ability Name="Таран">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
if GetPetActionCooldown(3) == 0 then
    CastPetAction(3);
end
]]></Lua>
      </Ability>
    </Rotation>
    <Rotation Name="Волчеры (Сбежавшая курица)">
      <HotKey Key="K" Modifier="Alt Shift" />
      <Ability Name="Сбежавшая курица">
        <SpellID>0</SpellID>
        <Target>None</Target>
        <CancelChannel>false</CancelChannel>
        <CancelCasting>false</CancelCasting>
        <IsUseIncombat>false</IsUseIncombat>
        <SetRecastDelay>false</SetRecastDelay>
        <IsMovingCheck>None</IsMovingCheck>
        <Lua><![CDATA[
ClearTarget();
TargetUnit("Сбежавшая курица");
if UnitExists("target") and CheckInteractDistance("target", 2) then
    InteractUnit("target");
end
]]></Lua>
      </Ability>
    </Rotation>
  </Profile>
</Profiles>